<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ¨ Guestbook - FenixLaboratory</title>
  <meta name="description" content="Sistema interactivo de dibujo y comentarios en tiempo real. Crea arte, comparte con la comunidad y participa en rankings. 50+ herramientas de dibujo, sistema de likes y galerÃ­a pÃºblica.">
  <meta name="keywords" content="guestbook, dibujo online, arte digital, comunidad, FenixLaboratory, canvas, pintura digital, galerÃ­a">
  <meta name="author" content="ThisIsFenix">
  
  <!-- Discord/Social Media Embeds -->
  <meta property="og:title" content="ğŸ¨ Guestbook - FenixLaboratory">
  <meta property="og:description" content="Sistema interactivo de dibujo con 50+ herramientas, rankings en tiempo real, sistema de likes y comentarios. Â¡Deja tu huella artÃ­stica en el laboratorio!">
  <meta property="og:image" content="https://thisisfenix.github.io/FenixLaboratory/guessbook/Preview-GuestBook.png">
  <meta property="og:url" content="https://thisisfenix.github.io/FenixLaboratory/guessbook/guestbook-new.html">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="FenixLaboratory Guestbook">
  
  <!-- Twitter Cards -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="ğŸ¨ Guestbook - FenixLaboratory">
  <meta name="twitter:description" content="Sistema de dibujo interactivo con herramientas avanzadas, rankings y comunidad activa. Â¡Crea arte digital y compÃ¡rtelo!">
  <meta name="twitter:image" content="https://thisisfenix.github.io/FenixLaboratory/guessbook/Preview-GuestBook.png">
  <meta name="twitter:creator" content="@AntiAnkush">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="Preview-GuestBook.png">
  <link rel="apple-touch-icon" href="Preview-GuestBook.png">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../placeholder/styles.css">
  <link rel="stylesheet" href="mobile-enhancements.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.min.js"></script>
  <script src="js/theme-adapter.js"></script>
  <script src="updates.js"></script>
  <script src="js/admin-panel.js"></script>
  <script src="js/mod-panel.js"></script>
  <script src="js/achievement-sync.js"></script>
  
  <style>
    /* AdaptaciÃ³n de temas para Guestbook */
    /* Asegurar que las imÃ¡genes de dibujos sean visibles */
    .drawing-img {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    /* Drawing cards adaptadas a temas */
    .drawing-card {
      background: var(--bg-light) !important;
      border: 1px solid var(--primary) !important;
    }
    
    .drawing-card .card-body {
      background: var(--bg-light) !important;
    }
    /* Botones adaptados */
    .btn-neon {
      border-color: var(--primary);
      color: var(--primary);
    }
    
    .btn-neon:hover {
      background: var(--primary);
      color: var(--bg-dark);
    }
    /* Modal y comentarios */
    .modal-content {
      background: var(--bg-light) !important;
      border: 2px solid var(--primary) !important;
    }
    
    .modal-header {
      border-bottom: 1px solid var(--primary) !important;
    }
    
    .modal-title {
      color: var(--primary) !important;
    }
    /* ImÃ¡genes en modales - visibles sin fondo */
    .modal-body img,
    .image-modal img {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      max-width: 100% !important;
      height: auto !important;
    }
    
    .form-control {
      background: var(--bg-dark) !important;
      border: 1px solid var(--primary) !important;
      color: var(--text-primary) !important;
    }
    
    .form-control:focus {
      background: var(--bg-dark) !important;
      border-color: var(--primary) !important;
      color: var(--text-primary) !important;
      box-shadow: 0 0 10px rgba(255, 107, 53, 0.3) !important;
    }
    /* Herramientas de dibujo */
    .control-section {
      background: var(--bg-light);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid rgba(255, 107, 53, 0.2);
    }
    
    .btn-group-custom .btn {
      background: var(--bg-dark);
      border: 1px solid var(--primary);
      color: var(--primary);
    }
    
    .btn-group-custom .btn.active,
    .btn-group-custom .btn:hover {
      background: var(--primary);
      color: var(--bg-dark);
    }
    
    .color-btn.active {
      border-color: var(--primary) !important;
      box-shadow: 0 0 10px var(--primary);
    }
    .canvas-container {
      border: 3px solid var(--primary);
      border-radius: 12px;
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      margin: 20px auto;
      display: block;
      padding: 15px;
      box-shadow: 0 8px 32px rgba(255, 107, 53, 0.2);
      position: relative;
      overflow: hidden;
    }
    .canvas-container::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, var(--primary), #ff8c42, var(--primary));
      border-radius: 12px;
      z-index: -1;
      animation: borderGlow 3s ease-in-out infinite alternate;
    }
    @keyframes borderGlow {
      0% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    #drawCanvas {
      border-radius: 8px;
      cursor: crosshair;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      transition: transform 0.2s ease;
      background: white; /* Fondo blanco por defecto */
    }
    
    #drawCanvas:hover {
      transform: scale(1.01);
    }
    .drawing-card {
      background: var(--bg-light);
      border: 1px solid rgba(255, 107, 53, 0.2);
      border-radius: 8px;
      margin-bottom: 20px;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .drawing-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(255, 107, 53, 0.3);
    }
    .top-drawing {
      position: relative;
      z-index: 10;
    }
    .top-drawing.rank-1 {
      border: 3px solid #FFD700 !important;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.8), 0 0 60px rgba(255, 215, 0, 0.4) !important;
      animation: goldAura 2s ease-in-out infinite alternate;
    }
    .top-drawing.rank-2 {
      border: 3px solid #C0C0C0 !important;
      box-shadow: 0 0 25px rgba(192, 192, 192, 0.7), 0 0 50px rgba(192, 192, 192, 0.3) !important;
      animation: silverAura 2s ease-in-out infinite alternate;
    }
    .top-drawing.rank-3 {
      border: 3px solid #CD7F32 !important;
      box-shadow: 0 0 20px rgba(205, 127, 50, 0.6), 0 0 40px rgba(205, 127, 50, 0.2) !important;
      animation: bronzeAura 2s ease-in-out infinite alternate;
    }
    @keyframes goldAura {
      0% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.8), 0 0 60px rgba(255, 215, 0, 0.4); }
      100% { box-shadow: 0 0 40px rgba(255, 215, 0, 1), 0 0 80px rgba(255, 215, 0, 0.6); }
    }
    @keyframes silverAura {
      0% { box-shadow: 0 0 25px rgba(192, 192, 192, 0.7), 0 0 50px rgba(192, 192, 192, 0.3); }
      100% { box-shadow: 0 0 35px rgba(192, 192, 192, 0.9), 0 0 70px rgba(192, 192, 192, 0.5); }
    }
    @keyframes bronzeAura {
      0% { box-shadow: 0 0 20px rgba(205, 127, 50, 0.6), 0 0 40px rgba(205, 127, 50, 0.2); }
      100% { box-shadow: 0 0 30px rgba(205, 127, 50, 0.8), 0 0 60px rgba(205, 127, 50, 0.4); }
    }
    .rank-badge {
      position: absolute;
      top: -10px;
      right: -10px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2em;
      z-index: 20;
      animation: pulse 1.5s ease-in-out infinite;
    }
    .rank-badge.rank-1 {
      background: linear-gradient(45deg, #FFD700, #FFA500);
      color: #000;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
    }
    .rank-badge.rank-2 {
      background: linear-gradient(45deg, #C0C0C0, #A0A0A0);
      color: #000;
      box-shadow: 0 0 15px rgba(192, 192, 192, 0.8);
    }
    .rank-badge.rank-3 {
      background: linear-gradient(45deg, #CD7F32, #B8860B);
      color: #fff;
      box-shadow: 0 0 15px rgba(205, 127, 50, 0.8);
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    .drawing-img {
      width: 100% !important;
      height: 200px !important;
      object-fit: contain !important;
      border-radius: 4px;
      transition: transform 0.3s ease;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    .drawing-card:hover .drawing-img {
      transform: scale(1.02);
    }
    
    /* Estilos para modal de comentarios */
    .comments-container {
      scrollbar-width: thin;
      scrollbar-color: var(--primary) transparent;
    }
    
    .comments-container::-webkit-scrollbar {
      width: 6px;
    }
    
    .comments-container::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .comments-container::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 3px;
    }
    
    .comment-item {
      transition: background-color 0.2s ease;
    }
    
    .comment-item:hover {
      background: rgba(255,255,255,0.08) !important;
    }
    
    .btn-neon {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
      transition: all 0.3s ease;
    }
    
    .btn-neon:hover {
      background: var(--primary);
      color: var(--bg-dark);
    }
    
    .control-section {
      margin-bottom: 1rem;
    }
    
    .control-section:last-child {
      margin-bottom: 0;
    }
    
    .btn-group-custom {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      justify-content: center;
    }
    
    .btn-group-custom .btn {
      flex: 0 0 auto;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
    
    @media (max-width: 991px) {
      .col-lg-4 {
        margin-top: 1rem;
      }
    }
    
    @media (max-width: 768px) {
      #drawCanvas {
        touch-action: none;
        max-width: 100%;
        height: auto;
      }
      .canvas-container {
        margin: 10px auto;
        touch-action: none;
        max-width: 95vw;
        padding: 10px;
        text-align: center;
      }
      
      /* Botones mÃ¡s grandes para mÃ³vil */
      .btn-group-custom .btn {
        font-size: 0.8rem;
        padding: 0.4rem 0.6rem;
        margin: 0.1rem;
        min-height: 36px;
        min-width: 44px;
      }
      
      /* Controles de color mÃ¡s grandes */
      .color-btn {
        width: 32px !important;
        height: 32px !important;
        margin: 2px !important;
      }
      
      /* Inputs mÃ¡s grandes */
      .form-control, .form-select {
        font-size: 16px !important;
        min-height: 44px;
        padding: 0.5rem 0.75rem;
      }
      
      /* Sliders mÃ¡s fÃ¡ciles de usar */
      .form-range {
        height: 8px;
      }
      
      .form-range::-webkit-slider-thumb {
        width: 24px;
        height: 24px;
      }
      
      /* Panel de control mÃ¡s espacioso */
      .control-section {
        margin-bottom: 1.5rem;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
      }
      
      /* Modal responsive mejorado */
      .image-modal {
        padding: 0 !important;
      }
      
      .image-modal > div {
        flex-direction: column !important;
        height: 100vh !important;
        max-height: 100vh !important;
        margin: 0 !important;
        border-radius: 0 !important;
      }
      
      .image-modal > div > div:first-child {
        flex: 0 0 auto !important;
        max-height: 35vh !important;
        padding: 10px !important;
        overflow: hidden;
      }
      
      .image-modal > div > div:last-child {
        flex: 1 !important;
        min-height: 0 !important;
        border-left: none !important;
        border-top: 2px solid var(--primary) !important;
        padding: 10px !important;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }
      
      .image-modal img {
        max-height: 25vh !important;
        width: 100% !important;
        object-fit: contain !important;
      }
      
      .image-modal textarea {
        font-size: 16px !important;
        min-height: 60px !important;
        resize: vertical;
        flex-shrink: 0;
      }
      
      /* Botones de acciÃ³n del modal */
      .image-modal .btn {
        min-height: 40px;
        font-size: 14px;
        padding: 0.4rem 0.8rem;
        margin: 0.2rem;
      }
      
      /* Header del modal mÃ¡s compacto */
      .image-modal .d-flex.justify-content-between {
        flex-wrap: wrap;
        gap: 0.3rem;
      }
      
      /* Comentarios mÃ¡s legibles y compactos */
      .comment-item {
        padding: 0.5rem !important;
        margin-bottom: 0.3rem !important;
        font-size: 13px !important;
        line-height: 1.3 !important;
        background: rgba(255, 255, 255, 0.05) !important;
        border-radius: 6px !important;
      }
      
      /* Contenedor de comentarios optimizado */
      .comments-container {
        flex: 1 !important;
        min-height: 0 !important;
        overflow-y: auto !important;
        max-height: 45vh !important;
        margin-bottom: 0.5rem !important;
      }
      
      /* Ãrea de comentario mÃ¡s compacta */
      .image-modal .comment-form {
        flex-shrink: 0 !important;
        margin-top: auto !important;
        padding-top: 0.5rem !important;
        border-top: 1px solid rgba(255, 255, 255, 0.1) !important;
      }
      
      /* NavegaciÃ³n de galerÃ­a */
      .gallery-nav {
        position: sticky;
        top: 0;
        z-index: 100;
        background: var(--bg-dark);
        padding: 1rem 0;
        margin-bottom: 1rem;
      }
      
      /* Cards de dibujos mÃ¡s grandes */
      .drawing-card {
        margin-bottom: 2rem;
      }
      
      .drawing-img {
        height: 250px !important;
      }
      
      /* Botones de like y comentarios mÃ¡s grandes */
      .drawing-card .btn {
        min-height: 44px;
        font-size: 16px;
        padding: 0.5rem 1rem;
      }
    }
    /* Botones flotantes para mÃ³viles */
    .mobile-refresh {
      position: fixed;
      bottom: 80px;
      right: 20px;
      z-index: 1000;
      background: rgba(255, 107, 53, 0.9);
      color: white;
      border: none;
      border-radius: 25px;
      width: 56px;
      height: 56px;
      font-size: 1.4em;
      box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
      transition: all 0.3s ease;
      display: none;
      backdrop-filter: blur(10px);
    }
    
    .mobile-refresh:hover {
      background: rgba(255, 140, 66, 0.95);
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(255, 107, 53, 0.6);
    }
    
    .mobile-refresh:active {
      transform: scale(0.95);
    }
    
    /* BotÃ³n para volver arriba en mÃ³vil */
    .mobile-scroll-top {
      position: fixed;
      bottom: 150px;
      right: 20px;
      z-index: 1000;
      background: rgba(0, 123, 255, 0.9);
      color: white;
      border: none;
      border-radius: 25px;
      width: 56px;
      height: 56px;
      font-size: 1.4em;
      box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
      transition: all 0.3s ease;
      display: none;
      backdrop-filter: blur(10px);
    }
    
    .mobile-scroll-top:hover {
      background: rgba(0, 123, 255, 0.95);
      transform: scale(1.05);
    }
    
    .mobile-scroll-top:active {
      transform: scale(0.95);
    }
    
    /* Barra de herramientas flotante para mÃ³vil */
    .mobile-toolbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(26, 26, 26, 0.95);
      backdrop-filter: blur(10px);
      border-top: 2px solid var(--primary);
      padding: 10px;
      z-index: 1001;
      display: none;
    }
    
    .mobile-toolbar .btn {
      flex: 1;
      margin: 0 2px;
      min-height: 44px;
      font-size: 0.9rem;
      border-radius: 8px;
    }
    
    @media (max-width: 768px) {
      .mobile-refresh,
      .mobile-scroll-top {
        display: block;
      }
      
      .mobile-toolbar {
        display: flex;
      }
      
      /* Ajustar contenido para la barra flotante */
      body {
        padding-bottom: 80px;
      }
      
      /* Ajustar botones de admin/mod en mÃ³vil */
      .version-toggle {
        position: fixed !important;
        top: 10px !important;
        right: 10px !important;
        z-index: 1002;
        display: flex;
        flex-wrap: wrap;
        gap: 2px;
        max-width: 200px;
      }
      
      .version-toggle .btn {
        font-size: 0.65rem;
        padding: 0.2rem 0.4rem;
        margin: 0;
        min-height: 28px;
        white-space: nowrap;
      }
    }
  </style>
</head>
<body>
  <!-- Botones flotantes para mÃ³viles -->
  <button class="mobile-refresh" onclick="refreshPage()" title="Actualizar Guestbook - Limpia cache y recarga la pÃ¡gina">
    â†»
  </button>
  
  <button class="mobile-scroll-top" onclick="scrollToTop()" title="Volver arriba">
    â†‘
  </button>
  
  <!-- Barra de herramientas flotante para mÃ³vil -->
  <div class="mobile-toolbar">
    <button class="btn btn-secondary" onclick="window.location.href='../index.html'">
      ğŸ  Lab
    </button>
    <button class="btn btn-primary" onclick="scrollToCanvas()">
      ğŸ¨ Dibujar
    </button>
    <button class="btn btn-info" onclick="scrollToGallery()">
      ğŸ›ï¸ GalerÃ­a
    </button>
    <button class="btn btn-success" onclick="document.getElementById('saveBtn').click()">
      ğŸ’¾ Guardar
    </button>
  </div>
  
  <div class="container py-4">
    <div class="version-toggle" style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
      <a href="guestbook-old.html" class="btn btn-outline-warning btn-sm">
        ğŸ“œ OLD Version
      </a>
      <button id="updatesToggle" class="btn btn-outline-info btn-sm ms-2" onclick="toggleUpdatesPanel()">
        ğŸš€ v2.0.9
      </button>
      <button id="vipStoreToggle" class="btn btn-outline-purple btn-sm ms-2" onclick="showVipStore()" style="border-color: #8b5cf6; color: #8b5cf6;">
        ğŸ’ VIP Store
      </button>
    </div>
    <!-- Panel de Updates -->
    <div id="updatesPanel" class="modal fade" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--bg-dark); border: 2px solid var(--primary);">
          <div class="modal-header" style="border-bottom: 1px solid var(--primary);">
            <h5 class="modal-title" style="color: var(--primary);">ğŸš€ Guestbook Updates v2.0.9</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button>
          </div>
          <div class="modal-body">
            <div class="mb-4">
              <div class="d-flex align-items-center gap-3 mb-3">
                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5em;">
                  ğŸ¨
                </div>
                <div>
                  <h6 style="color: var(--primary); margin: 0; font-size: 1.2em;">Guestbook v2.0.9</h6>
                  <small style="color: var(--text-secondary);">20 de Diciembre, 2024</small>
                </div>
                <div class="ms-auto">
                  <span class="badge" style="background: var(--primary); color: white; padding: 0.5rem 1rem;">ESTABLE</span>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <h6 style="color: var(--primary); margin-bottom: 1rem;">âœ¨ Nuevas CaracterÃ­sticas</h6>
                <div style="max-height: 300px; overflow-y: auto;">
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--primary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">ğŸ‘¤ Sistema de Perfiles</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">Fotos personalizadas y avatares inteligentes</div>
                  </div>
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--primary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">ğŸ¨ Avatares Ãšnicos</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">20 emojis diferentes por usuario</div>
                  </div>
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--primary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">ğŸ“Š Modal Clickeable</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">Perfil detallado con estadÃ­sticas</div>
                  </div>
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--primary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">ğŸŒˆ Tema Funky Atlas</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">Nuevo tema con colores vibrantes</div>
                  </div>
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--primary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">ğŸ“± Metadatos Discord</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">Optimizado para redes sociales</div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <h6 style="color: var(--secondary); margin-bottom: 1rem;">ğŸ”§ Mejoras y Correcciones</h6>
                <div style="max-height: 300px; overflow-y: auto;">
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--secondary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">ğŸ”§ Modal Optimizado</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">Perfil compacto que no cubre comentarios</div>
                  </div>
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--secondary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">ğŸ“± Comentarios Compactos</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">MÃ¡s contenido visible sin scroll</div>
                  </div>
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--secondary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">âš¡ ValidaciÃ³n AutomÃ¡tica</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">Archivos de imagen y tamaÃ±o</div>
                  </div>
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--secondary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">ğŸš« Errores Suprimidos</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">Extensiones del navegador</div>
                  </div>
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--secondary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">âœ¨ Efectos Visuales</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">Hover effects y transiciones suaves</div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="mt-4 p-3" style="background: var(--bg-light); border-radius: 8px; border: 1px solid var(--primary);">
              <h6 style="color: var(--primary); margin-bottom: 1rem;">ğŸ“ˆ EstadÃ­sticas de Desarrollo</h6>
              <div class="row text-center">
                <div class="col-3">
                  <div style="color: var(--primary); font-weight: bold; font-size: 1.2em;">10</div>
                  <div style="color: var(--text-secondary); font-size: 0.8em;">Versiones</div>
                </div>
                <div class="col-3">
                  <div style="color: var(--primary); font-weight: bold; font-size: 1.2em;">50+</div>
                  <div style="color: var(--text-secondary); font-size: 0.8em;">Herramientas</div>
                </div>
                <div class="col-3">
                  <div style="color: var(--primary); font-weight: bold; font-size: 1.2em;">11</div>
                  <div style="color: var(--text-secondary); font-size: 0.8em;">Temas</div>
                </div>
                <div class="col-3">
                  <div style="color: var(--primary); font-weight: bold; font-size: 1.2em;">4</div>
                  <div style="color: var(--text-secondary); font-size: 0.8em;">Meses</div>
                </div>
              </div>
            </div>
            
            <div class="mt-3 text-center">
              <a href="../README.md" target="_blank" class="btn btn-outline-primary btn-sm me-2">
                ğŸ“ Ver README completo
              </a>
              <a href="../updates.json" target="_blank" class="btn btn-outline-info btn-sm">
                ğŸ“„ Ver updates.json
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="text-center mb-4">
      <h1 style="color: var(--primary);">ğŸ¨ Guestbook</h1>
      <p style="color: var(--text-secondary);">Dibuja, comparte y comenta</p>
      <div class="d-flex justify-content-center gap-2 mb-3">
        <a href="../index.html" class="btn btn-outline-secondary btn-sm">
          ğŸ  Volver al Lab
        </a>
      </div>
    </div>
    
    <!-- Canvas Centrado -->
    <div class="text-center mb-3">
      <div class="canvas-container">
        <div class="mb-2">
          <div class="d-flex justify-content-between align-items-center">
            <div class="badge bg-primary">ğŸ¨ Lienzo de Dibujo</div>
            <div class="d-flex gap-2">
              <span class="badge bg-secondary" id="canvasInfo">600Ã—400</span>
              <span class="badge bg-info" id="zoomInfo">100%</span>
            </div>
          </div>
        </div>
        
        <div style="position: relative; display: inline-block;">
          <!-- Fondo GIF animado (z-index: 1) -->
          <div id="gifBackground" style="position: absolute; top: 0; left: 0; width: 600px; height: 400px; z-index: 1; display: none; border-radius: 8px; overflow: hidden;">
            <img id="gifBackgroundImg" style="width: 100%; height: 100%; object-fit: contain; image-rendering: auto;" alt="Fondo GIF">
          </div>
          <!-- Canvas transparente encima (z-index: 2) -->
          <canvas id="drawCanvas" width="600" height="400" style="position: relative; z-index: 2; background: transparent;"></canvas>
          <!-- Contenedor para stickers GIF animados (z-index: 3) -->
          <div id="gifStickersContainer" style="position: absolute; top: 0; left: 0; width: 600px; height: 400px; z-index: 3; pointer-events: none;"></div>
        </div>
      </div>
    </div>
    
    <!-- Panel de Control Horizontal Compacto -->
    <div class="card mb-4" style="background: var(--bg-light); border: 1px solid var(--primary); max-width: 1200px; margin: 0 auto 1rem auto;">
      <div class="card-header text-center py-1" style="background: linear-gradient(45deg, var(--primary), #ff8c42); color: var(--text-primary);">
        <h6 class="mb-0" style="font-size: 0.9rem;">ğŸ›ï¸ Panel de Control</h6>
      </div>
      <div class="card-body p-1">
        <div class="row g-1">
            <!-- Info del dibujo -->
            <div class="control-section mb-1">
              <div class="d-flex gap-1 align-items-end">
                <div style="width: 65%;">
                  <label class="form-label text-light small mb-1">ğŸ‘¤ Autor</label>
                  <div class="input-group input-group-sm">
                    <input type="text" id="authorName" placeholder="Tu nombre" class="form-control">
                    <button id="useProfileName" class="btn btn-outline-info" type="button" title="Usar nombre del perfil">
                      ğŸ‘¤
                    </button>
                  </div>
                </div>
                <div style="width: 35%;">
                  <label class="form-label text-light small mb-1">ğŸ“‚ CategorÃ­a</label>
                  <select id="categorySelect" class="form-select form-select-sm">
                    <option value="Arte">ğŸ¨ Arte</option>
                    <option value="Meme">ğŸ˜‚ Meme</option>
                    <option value="Divertido">ğŸ‰ Divertido</option>
                    <option value="Abstracto">ğŸŒŒ Abstracto</option>
                    <option value="Otro">âœ¨ Otro</option>
                  </select>
                </div>
              </div>
            </div>
          
            <!-- Botones Principales en Fila Horizontal -->
            <div class="control-section mb-1">
              <label class="form-label text-light small text-center d-block mb-1">ğŸ›ï¸ Controles Principales</label>
              <div class="d-flex flex-wrap gap-1 justify-content-center align-items-center">
                <!-- Herramientas Principales -->
                <button id="brushBtn" class="btn btn-neon btn-sm">ğŸ–Œï¸ Pincel</button>
                <button id="eraserBtn" class="btn btn-neon btn-sm">ğŸ§½ Borrar</button>
                <button id="bucketBtn" class="btn btn-neon btn-sm">ğŸª£ Relleno</button>
                <button id="textBtn" class="btn btn-neon btn-sm">ğŸ…°ï¸ Texto</button>
                
                <!-- Separador -->
                <div class="vr" style="height: 30px; opacity: 0.3;"></div>
                
                <!-- Acciones -->
                <button id="undoBtn" class="btn btn-outline-warning btn-sm">â†¶ Deshacer</button>
                <button id="redoBtn" class="btn btn-outline-info btn-sm">â†· Rehacer</button>
                <button id="clearBtn" class="btn btn-outline-danger btn-sm">ğŸ—‘ï¸ Limpiar</button>
                
                <!-- Separador -->
                <div class="vr" style="height: 30px; opacity: 0.3;"></div>
                
                <!-- Guardar -->
                <button id="saveBtn" class="btn btn-primary btn-sm">
                  <span id="saveText">ğŸš€ Guardar</span>
                  <span id="saveLoader" style="display: none;">â³ Guardando...</span>
                </button>
              </div>
            </div>
            
            <!-- Herramientas, Pinceles y Colores en una fila -->
            <div class="row g-1">
              <!-- Herramientas Extra -->
              <div class="col-4 text-center">
                <label class="form-label text-light small mb-1">âš™ï¸ Extras</label>
                <div class="d-flex flex-wrap gap-1 justify-content-center" style="min-height: 32px;">
                  <button id="stickerMoveBtn" class="btn btn-neon btn-sm" style="padding: 2px 6px; font-size: 0.7rem;">âœ‹</button>
                  <button id="sprayBtn" class="btn btn-neon btn-sm" style="padding: 2px 6px; font-size: 0.7rem;">ğŸ’¨</button>
                  <button id="lineBtn" class="btn btn-neon btn-sm" style="padding: 2px 6px; font-size: 0.7rem;">ğŸ“</button>
                  <button id="eyedropperBtn" class="btn btn-neon btn-sm" style="padding: 2px 6px; font-size: 0.7rem;">ğŸ’§</button>
                </div>
              </div>
              
              <!-- Pincel -->
              <div class="col-4 text-center">
                <label class="form-label text-light small mb-1">ğŸ“ Pincel</label>
                <div class="d-flex align-items-center gap-1 mb-1 justify-content-center" style="height: 16px;">
                  <input type="range" id="brushSize" min="1" max="20" value="3" class="form-range" style="width: 60px; height: 4px;">
                  <span id="sizeDisplay" class="badge bg-secondary" style="font-size: 0.6rem; padding: 1px 4px;">3px</span>
                </div>
                <div class="d-flex align-items-center gap-1 justify-content-center" style="height: 16px;">
                  <input type="range" id="opacitySlider" min="10" max="100" value="100" class="form-range" style="width: 60px; height: 4px;">
                  <span id="opacityDisplay" class="badge bg-secondary" style="font-size: 0.6rem; padding: 1px 4px;">100%</span>
                </div>
              </div>
              
              <!-- Colores -->
              <div class="col-4">
                <label class="form-label text-light small mb-1">ğŸ¨ Colores</label>
                <div class="d-flex flex-wrap gap-1 justify-content-center" style="line-height: 1;">
                  <div class="color-btn active" style="background: #000; width: 16px; height: 16px; border-radius: 50%; cursor: pointer; border: 1px solid #fff; margin: 1px;" data-color="#000000"></div>
                  <div class="color-btn" style="background: #ff6b35; width: 16px; height: 16px; border-radius: 50%; cursor: pointer; border: 1px solid #fff; margin: 1px;" data-color="#ff6b35"></div>
                  <div class="color-btn" style="background: #f00; width: 16px; height: 16px; border-radius: 50%; cursor: pointer; border: 1px solid #fff; margin: 1px;" data-color="#ff0000"></div>
                  <div class="color-btn" style="background: #0f0; width: 16px; height: 16px; border-radius: 50%; cursor: pointer; border: 1px solid #fff; margin: 1px;" data-color="#00ff00"></div>
                  <div class="color-btn" style="background: #00f; width: 16px; height: 16px; border-radius: 50%; cursor: pointer; border: 1px solid #fff; margin: 1px;" data-color="#0000ff"></div>
                  <div class="color-btn" style="background: #fff; width: 16px; height: 16px; border-radius: 50%; cursor: pointer; border: 1px solid #000; margin: 1px;" data-color="#ffffff"></div>
                  <div class="color-btn" style="background: #ff0080; width: 16px; height: 16px; border-radius: 50%; cursor: pointer; border: 1px solid #fff; margin: 1px;" data-color="#ff0080"></div>
                  <div class="color-btn" style="background: #00ffff; width: 16px; height: 16px; border-radius: 50%; cursor: pointer; border: 1px solid #fff; margin: 1px;" data-color="#00ffff"></div>
                  <div class="color-btn" style="background: #ffff00; width: 16px; height: 16px; border-radius: 50%; cursor: pointer; border: 1px solid #fff; margin: 1px;" data-color="#ffff00"></div>
                  <div class="color-btn" style="background: #ff8000; width: 16px; height: 16px; border-radius: 50%; cursor: pointer; border: 1px solid #fff; margin: 1px;" data-color="#ff8000"></div>
                  <div class="color-btn" style="background: #8000ff; width: 16px; height: 16px; border-radius: 50%; cursor: pointer; border: 1px solid #fff; margin: 1px;" data-color="#8000ff"></div>
                  <div class="color-btn" style="background: #00ff80; width: 16px; height: 16px; border-radius: 50%; cursor: pointer; border: 1px solid #fff; margin: 1px;" data-color="#00ff80"></div>
                  <input type="color" id="customColor" value="#ff6b35" class="form-control" style="width: 18px; height: 18px; padding: 0; border: 1px solid #fff; border-radius: 50%; margin: 1px;">
                </div>
              </div>
            </div>
            
            <!-- Botones de Herramientas en Fila Horizontal -->
            <div class="control-section mb-1">
              <label class="form-label text-light small text-center d-block mb-1">ğŸ› ï¸ Herramientas Avanzadas</label>
              <div class="d-flex flex-wrap gap-1 justify-content-center">
                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#extraTools">âš™ï¸ Extras</button>
                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#effects">âœ¨ Efectos</button>
                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#filters">ğŸ¨ Filtros</button>
                <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#mediaTools">ğŸ–¼ï¸ Media</button>
                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#advancedTools">ğŸ”§ Avanzadas</button>
                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#canvasSize">ğŸ“ Canvas</button>
                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#brushConfig">âš™ï¸ Pincel</button>
                <button class="btn btn-outline-info btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#gifAnimation">ğŸ¬ GIF</button>
                <button class="btn btn-outline-success btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#viewFile">ğŸ” Vista</button>
                <button class="btn btn-outline-warning btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#layerTools">ğŸ† Capas</button>
              </div>
              
              <!-- Contenido colapsable -->
              <div class="collapse mt-2" id="extraTools">
                <div class="btn-group-custom mb-2">
                  <button id="sprayBtn" class="btn btn-neon btn-sm">ğŸ’¨ Spray</button>
                  <button id="selectBtn" class="btn btn-neon btn-sm">ğŸ”² Seleccionar</button>
                  <button id="lineBtn" class="btn btn-neon btn-sm">ğŸ“ LÃ­nea</button>
                  <button id="eyedropperBtn" class="btn btn-neon btn-sm">ğŸ’§ Cuentagotas</button>
                </div>
              </div>
              
              <div class="collapse mt-2" id="effects">
                <div class="btn-group-custom mb-2">
                  <button id="gradientBtn" class="btn btn-neon btn-sm">ğŸŒˆ Gradiente</button>
                  <button id="patternBtn" class="btn btn-neon btn-sm">ğŸ”³ PatrÃ³n</button>
                  <button id="symmetryBtn" class="btn btn-neon btn-sm">ğŸª SimetrÃ­a</button>
                  <button id="neonBtn" class="btn btn-neon btn-sm">ğŸ’« NeÃ³n</button>
                  <button id="watercolorBtn" class="btn btn-neon btn-sm">ğŸ¨ Acuarela</button>
                </div>
              </div>
              
              <div class="collapse mt-2" id="filters">
                <div class="btn-group-custom mb-2">
                  <button id="blurBtn" class="btn btn-neon btn-sm">ğŸŒ«ï¸ Blur</button>
                  <button id="pixelBtn" class="btn btn-neon btn-sm">ğŸ–¼ï¸ Pixel</button>
                  <button id="vintageBtn" class="btn btn-neon btn-sm">ğŸ“· Vintage</button>
                  <button id="oleoBtn" class="btn btn-neon btn-sm">ğŸ¨ Ã“leo</button>
                  <button id="carbonBtn" class="btn btn-neon btn-sm">âœï¸ CarbÃ³n</button>
                  <button id="clearFiltersBtn" class="btn btn-warning btn-sm">âŒ Quitar</button>
                </div>
              </div>
              
              <div class="collapse mt-2" id="mediaTools">
                <div class="mb-2">
                  <label class="form-label text-light small mb-1">ğŸŒ„ Fondo de Imagen</label>
                  <input type="file" id="bgUpload" accept=".png,.jpg,.jpeg,.gif" class="form-control form-control-sm mb-1">
                  <button id="setBgBtn" class="btn btn-outline-primary btn-sm w-100" disabled>ğŸ–¼ï¸ Aplicar Fondo</button>
                  <button id="clearBgBtn" class="btn btn-outline-warning btn-sm w-100 mt-1">âŒ Quitar Fondo</button>
                  <small class="text-muted d-block mt-1">ğŸ“¸ PNG/JPG en canvas â€¢ ğŸ¬ GIF como fondo visual animado<br>
                  <strong style="color: var(--primary);">âœ¨ Dibuja encima del GIF animado</strong><br>
                  <span style="color: #ffc107;">âš ï¸ GIFs >800KB no se guardan en Firebase (solo locales)</span></small>
                </div>
                <div>
                  <label class="form-label text-light small mb-1">ğŸ·ï¸ Stickers Personalizados</label>
                  <input type="file" id="stickerUpload" accept=".png,.jpg,.jpeg,.gif" class="form-control form-control-sm mb-1">
                  <button id="placeStickerBtn" class="btn btn-outline-success btn-sm w-100" disabled>ğŸ“Œ Colocar Sticker</button>
                  <small class="text-muted d-block mt-1">ğŸ–¼ï¸ PNG/JPG en canvas â€¢ ğŸ¦ GIF como elemento animado<br>
                  <strong style="color: var(--primary);">âœ¨ GIFs totalmente animados y arrastrables</strong><br>
                  <span style="color: #ffc107;">âš ï¸ GIFs >800KB no se guardan en Firebase (solo locales)</span></small>
                </div>
              </div>
              
              <div class="collapse mt-2" id="layerTools">
                <div class="mb-2">
                  <label class="form-label text-light small">ğŸ† Modo Capas</label>
                  <div class="d-flex flex-wrap gap-1 justify-content-center mb-2">
                    <button id="layerModeToggle" class="btn btn-outline-primary btn-sm" title="Cambiar entre modo simple y modo capas">ğŸ¨ Modo Capas</button>
                    <button id="addLayerBtn" class="btn btn-outline-success btn-sm">â• Nueva</button>
                    <button id="deleteLayerBtn" class="btn btn-outline-danger btn-sm">â– Eliminar</button>
                  </div>
                  <div id="layerControls" style="display: none;">
                    <div id="layersList" style="max-height: 120px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 6px; padding: 4px; margin-top: 8px;">
                      <!-- Las capas se generarÃ¡n dinÃ¡micamente -->
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="collapse mt-2" id="advancedTools">
                <div class="btn-group-custom mb-2">
                  <button id="rulerBtn" class="btn btn-neon btn-sm">ğŸ“ Reglas</button>
                  <button id="perspectiveBtn" class="btn btn-neon btn-sm">ğŸ“ Perspectiva</button>
                  <button id="cloneBtn" class="btn btn-neon btn-sm">ğŸ“‹ Clonar</button>
                  <button id="histogramBtn" class="btn btn-neon btn-sm">ğŸ“Š Histograma</button>
                </div>
              </div>
              
              <div class="collapse mt-2" id="canvasSize">
                <div class="btn-group-custom mb-2">
                  <button id="smallCanvas" class="btn btn-outline-info btn-sm">400Ã—300</button>
                  <button id="mediumCanvas" class="btn btn-info btn-sm">600Ã—400</button>
                  <button id="largeCanvas" class="btn btn-outline-info btn-sm">800Ã—600</button>
                  <button id="wideCanvas" class="btn btn-outline-info btn-sm">800Ã—400</button>
                </div>
                <div class="d-flex gap-1 mb-2">
                  <input type="number" id="customWidth" placeholder="W" class="form-control form-control-sm" min="100" max="1200" value="600">
                  <span class="align-self-center text-light">Ã—</span>
                  <input type="number" id="customHeight" placeholder="H" class="form-control form-control-sm" min="100" max="800" value="400">
                </div>
                <button id="customCanvasBtn" class="btn btn-outline-info btn-sm w-100">ğŸ“ Aplicar</button>
              </div>
              
              <div class="collapse mt-2" id="brushConfig">
                <select id="brushType" class="form-select form-select-sm" style="width: 150px; margin: 0 auto;">
                  <option value="normal">ğŸ–Œï¸ Normal</option>
                  <option value="fine">âœï¸ Fino</option>
                  <option value="thick">ğŸ–ï¸ Grueso</option>
                  <option value="art">ğŸ¨ Arte</option>
                </select>
              </div>
              
              <div class="collapse mt-2" id="gifAnimation">
                <div class="btn-group-custom mb-2">
                  <button id="captureFrameBtn" class="btn btn-outline-primary btn-sm">ğŸ“¸ Capturar</button>
                  <button id="clearFramesBtn" class="btn btn-outline-warning btn-sm">ğŸ—‘ï¸ Limpiar</button>
                </div>
                <div id="frameCounter" class="text-center small text-muted">0 frames</div>
              </div>
              
              <div class="collapse mt-2" id="viewFile">
                <div class="btn-group-custom mb-2">
                  <button id="zoomInBtn" class="btn btn-outline-success btn-sm">ğŸ”+ Zoom</button>
                  <button id="zoomOutBtn" class="btn btn-outline-success btn-sm">ğŸ”- Zoom</button>
                </div>
                <div class="btn-group-custom mb-2">
                  <input type="file" id="importBtn" accept="image/*" style="display:none">
                  <button class="btn btn-info btn-sm" onclick="document.getElementById('importBtn').click()">ğŸ“ Importar</button>
                  <button id="exportBtn" class="btn btn-success btn-sm">ğŸ’¾ Exportar</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Rankings y Sugerencias -->
    <hr style="border-color: var(--primary);">
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card" style="background: var(--bg-light); border: 1px solid var(--primary);">
          <div class="card-header" style="background: linear-gradient(45deg, #ffd700, #ffed4e); color: #000;">
            <h5 class="mb-0">ğŸ† Top Rankings</h5>
          </div>
          <div class="card-body p-3">
            <div class="mb-3">
              <h6 class="text-warning">ğŸ‘‘ Top Artistas</h6>
              <div id="topArtists" class="small" style="color: var(--text-primary);">
                <div class="d-flex justify-content-between mb-1">
                  <span>ğŸ¥‡ Cargando...</span>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <h6 class="text-info">â¤ï¸ MÃ¡s Populares</h6>
              <div id="topLiked" class="small" style="color: var(--text-primary);">
                <div class="d-flex justify-content-between mb-1">
                  <span>ğŸ¥‡ Cargando...</span>
                </div>
              </div>
            </div>
            <div>
              <h6 class="text-success">ğŸ”¥ MÃ¡s Activos</h6>
              <div id="topActive" class="small" style="color: var(--text-primary);">
                <div class="d-flex justify-content-between mb-1">
                  <span>ğŸ¥‡ Cargando...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card" style="background: var(--bg-light); border: 1px solid var(--primary);">
          <div class="card-header" style="background: linear-gradient(45deg, #ff6b35, #ff8c42); color: white;">
            <h5 class="mb-0">ğŸ’¡ Sugerencias</h5>
          </div>
          <div class="card-body p-3">
            <div class="mb-3">
              <textarea id="suggestionText" class="form-control form-control-sm" rows="3" placeholder="Tu sugerencia..."></textarea>
            </div>
            <div class="mb-3">
              <input type="file" id="suggestionImage" accept="image/*" class="form-control form-control-sm">
              <small class="text-muted">Opcional: Adjunta una imagen</small>
            </div>
            <div class="mb-3">
              <select id="suggestionType" class="form-select form-select-sm">
                <option value="feature">âœ¨ Nueva FunciÃ³n</option>
                <option value="bug">ğŸ› Reportar Bug</option>
                <option value="improvement">ğŸ”§ Mejora</option>
                <option value="other">ğŸ’­ Otro</option>
              </select>
            </div>
            <button id="submitSuggestion" class="btn btn-primary btn-sm w-100">ğŸ“¤ Enviar</button>
            <div id="recentSuggestions" class="mt-3" style="max-height: 200px; overflow-y: auto;">
              <small class="text-muted">Cargando sugerencias...</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- GalerÃ­a -->
    <div class="text-center mb-4">
      <h2 style="color: var(--primary);">ğŸ›ï¸ GalerÃ­a Interactiva</h2>
      <p style="color: var(--text-secondary);">Sistema de comentarios y likes en tiempo real</p>
    </div>
    
    <div class="row justify-content-center mb-4">
      <div class="col-md-8">
        <div class="d-flex justify-content-center gap-2 flex-wrap">
          <input type="text" id="searchAuthor" placeholder="Buscar por autor" class="form-control" style="width: 200px;">
          <select id="filterCategory" class="form-select" style="width: 180px;">
            <option value="">Todas las categorÃ­as</option>
            <option value="Arte">ğŸ¨ Arte</option>
            <option value="Meme">ğŸ˜‚ Meme</option>
            <option value="Divertido">ğŸ‰ Divertido</option>
            <option value="Abstracto">ğŸŒŒ Abstracto</option>
            <option value="Otro">âœ¨ Otro</option>
          </select>
          <button id="clearFilters" class="btn btn-outline-secondary">âŒ Limpiar</button>
          <button id="reloadData" class="btn btn-outline-info">ğŸ”„ Recargar</button>
        </div>
      </div>
    </div>
    <div id="gallery" class="row">
      <div class="col-12 text-center" style="color: var(--text-secondary);">
        <div class="spinner-border" role="status" style="color: var(--primary);">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2">Cargando galerÃ­a...</p>
      </div>
    </div>
    
    <div id="pagination" class="text-center mt-4"></div>
  </div>
  
  <!-- Scripts modulares -->
  <script type="module">
    import { FirebaseManager } from './js/firebase.js';
    import { CanvasManager } from './js/canvas.js';
    import { GalleryManager } from './js/gallery.js';
    import { UIManager } from './js/ui.js';
    import { ProfileManager } from './js/profiles.js';
    import { MobileOptimizer } from './js/mobile-optimizer.js';
    import { SoundSystem } from './js/sound-system.js';
    import { AutoModerationSystem } from './js/auto-moderation.js';
    import { VipStore } from './js/vip-store.js';
    import { FriendsSystem } from './js/friends-system.js';
    
    class GuestbookApp {
      constructor() {
        this.firebase = new FirebaseManager();
        this.canvas = new CanvasManager();
        this.gallery = new GalleryManager(this.firebase);
        this.ui = new UIManager();
        this.profiles = new ProfileManager(this.firebase);
        this.mobileOptimizer = new MobileOptimizer();
        this.soundSystem = new SoundSystem();
        this.autoModeration = new AutoModerationSystem(this.firebase);
        this.vipStore = new VipStore();
        this.friendsSystem = new FriendsSystem(this.firebase, this.profiles);
        
        // Hacer disponible globalmente
        window.guestbookApp = this;
        window.friendsSystem = this.friendsSystem;
      }
      
      async init() {
        try {
          this.setupCanvasControls();
          await this.gallery.init();
          await this.loadRecentSuggestions();
          
          // Cargar nombre del perfil si estÃ¡ logueado
          this.loadInitialProfileData();
          
          // ğŸ”— Configurar sincronizaciÃ³n de logros
          this.setupGuestbookAchievementSync();
          
          // Actualizar rankings despuÃ©s de cargar la galerÃ­a
          setTimeout(() => {
            if (this.gallery.allDrawings && this.gallery.allDrawings.length > 0) {
              this.gallery.updateRankingsSection();
              
              // Actualizar estadÃ­sticas del perfil con todos los dibujos
              if (this.profiles && this.profiles.isLoggedIn()) {
                this.profiles.updateStats(this.gallery.allDrawings);
              }
            }
          }, 1000);
          
          console.log('âœ… Guestbook NEW inicializado correctamente');
          
          // Mostrar informaciÃ³n de dispositivo si estÃ¡ en modo debug
          if (this.mobileOptimizer) {
            this.mobileOptimizer.showDebugInfo();
          }
        } catch (error) {
          console.error('âŒ Error inicializando:', error);
        }
      }
      
      loadInitialProfileData() {
        // Cargar nombre del perfil si estÃ¡ logueado
        if (this.profiles && this.profiles.isLoggedIn()) {
          const authorInput = document.getElementById('authorName');
          if (authorInput && !authorInput.value) {
            authorInput.value = this.profiles.currentProfile.username;
          }
        }
      }
      
      setupCanvasControls() {
        // Configurar detecciÃ³n de cambios en canvas
        this.setupUnsavedChangesDetection();
        
        // Controles de herramientas
        document.getElementById('brushBtn')?.addEventListener('click', () => {
          this.canvas.setTool('brush');
          this.currentTool = 'brush';
          this.updateToolButtons('brushBtn');
        });
        document.getElementById('eraserBtn')?.addEventListener('click', () => {
          this.canvas.setTool('eraser');
          this.currentTool = 'eraser';
          this.updateToolButtons('eraserBtn');
        });
        document.getElementById('bucketBtn')?.addEventListener('click', () => {
          this.canvas.setTool('bucket');
          this.currentTool = 'bucket';
          this.updateToolButtons('bucketBtn');
        });
        document.getElementById('textBtn')?.addEventListener('click', () => {
          this.canvas.setTool('text');
          this.currentTool = 'text';
          this.updateToolButtons('textBtn');
        });
        document.getElementById('stickerMoveBtn')?.addEventListener('click', () => this.setStickerMoveTool());
        
        // Controles de tamaÃ±o y opacidad
        document.getElementById('brushSize')?.addEventListener('input', (e) => {
          this.canvas.setSize(e.target.value);
          document.getElementById('sizeDisplay').textContent = e.target.value + 'px';
        });
        
        document.getElementById('opacitySlider')?.addEventListener('input', (e) => {
          this.canvas.setOpacity(e.target.value);
          document.getElementById('opacityDisplay').textContent = e.target.value + '%';
        });
        
        // Controles de color
        document.querySelectorAll('.color-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelector('.color-btn.active')?.classList.remove('active');
            btn.classList.add('active');
            this.canvas.setColor(btn.dataset.color);
            this.saveUserColor(btn.dataset.color);
          });
        });
        
        document.getElementById('customColor')?.addEventListener('change', (e) => {
          this.canvas.setColor(e.target.value);
          document.querySelector('.color-btn.active')?.classList.remove('active');
          this.saveUserColor(e.target.value);
        });
        
        // Cargar color guardado del usuario
        this.loadUserColor();
        
        // El manejo de fotos de perfil ahora se hace en ProfileManager
        
        // Toggle de modo capas
        document.getElementById('layerModeToggle')?.addEventListener('click', () => {
          this.canvas.toggleLayerMode();
        });
        
        // Controles de capas
        document.getElementById('addLayerBtn')?.addEventListener('click', () => {
          this.canvas.addLayer();
        });
        
        document.getElementById('deleteLayerBtn')?.addEventListener('click', () => {
          this.canvas.deleteLayer();
        });
        
        // Controles de acciÃ³n
        document.getElementById('undoBtn')?.addEventListener('click', () => this.canvas.undo());
        document.getElementById('clearBtn')?.addEventListener('click', () => {
          if (confirm('Â¿Limpiar todo el dibujo?')) {
            this.canvas.clear();
            // Limpiar tambiÃ©n fondos y stickers GIF
            this.hideVisualGifBackground();
            document.getElementById('gifStickersContainer').innerHTML = '';
            this.gifStickers = [];
            this.currentBackgroundImage = null;
            this.isBackgroundGif = false;
            // Resetear cambios sin guardar
            window.hasUnsavedChanges = false;
          }
        });
        
        // BotÃ³n de guardar
        document.getElementById('saveBtn')?.addEventListener('click', async () => {
          await this.saveDrawing();
        });
        
        // Herramientas extras
        const tools = ['spray', 'select', 'line', 'eyedropper'];
        tools.forEach(tool => {
          const btn = document.getElementById(tool + 'Btn');
          if (btn) {
            btn.addEventListener('click', () => {
              this.canvas.setTool(tool);
              this.currentTool = tool;
              this.updateToolButtons(tool + 'Btn');
            });
          }
        });
        
        // Efectos
        const effects = ['gradient', 'pattern', 'symmetry', 'neon', 'watercolor'];
        effects.forEach(effect => {
          const btn = document.getElementById(effect + 'Btn');
          if (btn) {
            btn.addEventListener('click', () => this.canvas.setEffect(effect));
          }
        });
        
        // Filtros
        const filters = ['blur', 'pixel', 'vintage', 'oleo', 'carbon'];
        filters.forEach(filter => {
          const btn = document.getElementById(filter + 'Btn');
          if (btn) {
            btn.addEventListener('click', () => this.canvas.applyFilter(filter));
          }
        });
        
        // Herramientas avanzadas
        const advancedTools = ['ruler', 'perspective', 'clone', 'histogram'];
        advancedTools.forEach(tool => {
          const btn = document.getElementById(tool + 'Btn');
          if (btn) {
            btn.addEventListener('click', () => this.canvas.setAdvancedTool(tool));
          }
        });
        
        // Canvas size controls
        document.getElementById('smallCanvas')?.addEventListener('click', () => this.resizeCanvas(400, 300));
        document.getElementById('mediumCanvas')?.addEventListener('click', () => this.resizeCanvas(600, 400));
        document.getElementById('largeCanvas')?.addEventListener('click', () => this.resizeCanvas(800, 600));
        document.getElementById('wideCanvas')?.addEventListener('click', () => this.resizeCanvas(800, 400));
        document.getElementById('customCanvasBtn')?.addEventListener('click', () => {
          const width = parseInt(document.getElementById('customWidth').value) || 600;
          const height = parseInt(document.getElementById('customHeight').value) || 400;
          this.resizeCanvas(width, height);
        });
        
        // Brush type
        document.getElementById('brushType')?.addEventListener('change', (e) => {
          this.canvas.setBrushType(e.target.value);
        });
        
        // Zoom
        document.getElementById('zoomInBtn')?.addEventListener('click', () => {
          this.canvas.zoomIn();
          this.updateZoomInfo();
        });
        document.getElementById('zoomOutBtn')?.addEventListener('click', () => {
          this.canvas.zoomOut();
          this.updateZoomInfo();
        });
        
        // Import/Export
        document.getElementById('importBtn')?.addEventListener('change', (e) => this.handleImport(e));
        
        // Fondos y stickers
        document.getElementById('bgUpload')?.addEventListener('change', (e) => this.handleBackgroundUpload(e));
        document.getElementById('setBgBtn')?.addEventListener('click', () => this.setBackground());
        document.getElementById('stickerUpload')?.addEventListener('change', (e) => this.handleStickerUpload(e));
        document.getElementById('placeStickerBtn')?.addEventListener('click', () => this.placeSticker());
        
        // BotÃ³n para limpiar fondo
        const clearBgBtn = document.createElement('button');
        clearBgBtn.className = 'btn btn-outline-warning btn-sm w-100 mt-1';
        clearBgBtn.innerHTML = 'âŒ Quitar Fondo';
        clearBgBtn.addEventListener('click', () => this.clearBackground());
        document.getElementById('setBgBtn').parentNode.appendChild(clearBgBtn);
        // Controles de GIF
        document.getElementById('captureFrameBtn')?.addEventListener('click', () => {
          this.canvas.captureFrame();
          this.updateFrameCounter();
        });
        document.getElementById('clearFramesBtn')?.addEventListener('click', () => {
          if (confirm('Â¿Eliminar todos los frames capturados?')) {
            this.canvas.clearFrames();
            this.updateFrameCounter();
          }
        });
        
        // Filtros y acciones
        document.getElementById('clearFiltersBtn')?.addEventListener('click', () => this.canvas.clearFilters());
        document.getElementById('redoBtn')?.addEventListener('click', () => this.canvas.redo());
        document.getElementById('exportBtn')?.addEventListener('click', () => this.canvas.exportImage());
        
        // Sugerencias y datos
        document.getElementById('submitSuggestion')?.addEventListener('click', () => this.submitSuggestion());
        document.getElementById('reloadData')?.addEventListener('click', () => this.gallery.loadGallery());
        
        // Inicializar lista de capas y contador de frames
        this.canvas.updateLayersList();
        this.updateFrameCounter();
        
        // Inicializar variables para GIFs
        this.currentBackgroundImage = null;
        this.isBackgroundGif = false;
        this.currentStickerImage = null;
        this.isStickerGif = false;
        this.gifStickers = [];
        this.selectedSticker = null;
        this.isDragging = false;
        this.currentTool = 'brush';
        
        // Configurar canvas para GIFs
        this.setupGifCanvas();
        
        // Configurar eventos para mover stickers
        this.setupStickerMoveEvents();
        
        // Configurar mejoras mÃ³viles
        this.setupMobileEnhancements();
        
        // Iniciar verificaciÃ³n periÃ³dica de reportes
        this.startReportCounterUpdates();
        
        // Inicializar paneles admin/mod si estÃ¡n disponibles
        if (typeof initAdminPanel === 'function') {
          initAdminPanel(this.firebase);
        }
        if (typeof initModPanel === 'function') {
          initModPanel(this.firebase);
        }
      }
      
      setupGifCanvas() {
        // Ajustar contenedores GIF al cambiar tamaÃ±o de canvas
        const observer = new ResizeObserver(() => {
          const canvas = this.canvas.canvas;
          const gifBackground = document.getElementById('gifBackground');
          const gifStickersContainer = document.getElementById('gifStickersContainer');
          
          if (gifBackground && canvas) {
            gifBackground.style.width = canvas.width + 'px';
            gifBackground.style.height = canvas.height + 'px';
          }
          
          if (gifStickersContainer && canvas) {
            gifStickersContainer.style.width = canvas.width + 'px';
            gifStickersContainer.style.height = canvas.height + 'px';
          }
        });
        
        if (this.canvas.canvas) {
          observer.observe(this.canvas.canvas);
        }
      }
      
      resizeCanvas(width, height) {
        if (!this.canvas.isEmpty() && !confirm('Â¿Cambiar tamaÃ±o del canvas? Se perderÃ¡ el dibujo actual.')) return;
        
        this.canvas.canvas.width = width;
        this.canvas.canvas.height = height;
        this.canvas.ctx.lineCap = 'round';
        this.canvas.ctx.lineJoin = 'round';
        
        const canvasInfo = document.getElementById('canvasInfo');
        if (canvasInfo) {
          canvasInfo.textContent = `${width}Ã—${height}`;
        }
        
        // Actualizar contenedores GIF
        const gifBackground = document.getElementById('gifBackground');
        const gifStickersContainer = document.getElementById('gifStickersContainer');
        
        if (gifBackground) {
          gifBackground.style.width = width + 'px';
          gifBackground.style.height = height + 'px';
        }
        
        if (gifStickersContainer) {
          gifStickersContainer.style.width = width + 'px';
          gifStickersContainer.style.height = height + 'px';
        }
        
        this.canvas.saveState();
      }
      
      updateZoomInfo() {
        const zoomInfo = document.getElementById('zoomInfo');
        if (zoomInfo && this.canvas.zoomLevel) {
          zoomInfo.textContent = Math.round(this.canvas.zoomLevel * 100) + '%';
        }
      }
      
      updateFrameCounter() {
        const counter = document.getElementById('frameCounter');
        if (counter) {
          const count = this.canvas.getFrameCount();
          counter.textContent = `${count} frame${count !== 1 ? 's' : ''}`;
          counter.style.color = count > 1 ? 'var(--primary)' : 'var(--text-secondary)';
        }
      }
      handleImport(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
        if (!validTypes.includes(file.type)) {
          this.ui.showNotification('ğŸš« Formato no soportado.', 'error');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            this.canvas.ctx.clearRect(0, 0, this.canvas.canvas.width, this.canvas.canvas.height);
            this.canvas.ctx.drawImage(img, 0, 0, this.canvas.canvas.width, this.canvas.canvas.height);
            this.canvas.saveState();
            this.ui.showNotification('âœ… Imagen importada', 'success');
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
      
      async saveDrawing() {
        const saveBtn = document.getElementById('saveBtn');
        const saveText = document.getElementById('saveText');
        const saveLoader = document.getElementById('saveLoader');
        
        if (this.canvas.isEmpty()) {
          this.ui.showNotification('Â¡Dibuja algo primero!', 'error');
          return;
        }
        
        saveBtn.disabled = true;
        saveText.style.display = 'none';
        saveLoader.style.display = 'inline';
        
        try {
          // Mostrar mensaje si es GIF animado
          const frameCount = this.canvas.getFrameCount();
          if (frameCount > 1) {
            this.ui.showNotification('ğŸ¬ Creando GIF animado...', 'info');
          }
          
          let imageData = await this.canvas.getImageData();
          const author = document.getElementById('authorName').value || 'AnÃ³nimo';
          const category = document.getElementById('categorySelect').value;
          
          // Auto-moderaciÃ³n
          const tempDrawingData = { autor: author, imagenData: imageData };
          const recentDrawings = this.gallery.allDrawings || [];
          const moderationResult = await this.autoModeration.analyzeDrawing(tempDrawingData, recentDrawings);
          
          if (moderationResult.action === 'block') {
            this.ui.showNotification('ğŸš« ' + moderationResult.issues.join(', '), 'error');
            return;
          }
          
          if (moderationResult.action === 'flag') {
            this.ui.showNotification('âš ï¸ Contenido marcado para revisiÃ³n', 'warning');
          }
          
          // Comprimir imagen si es muy grande
          const imageSize = imageData.length;
          if (imageSize > 800000) { // ~800KB
            console.log('ğŸ—‚ï¸ Comprimiendo imagen:', imageSize, 'bytes');
            imageData = await this.compressImage(imageData, 600);
            console.log('âœ… Imagen comprimida:', imageData.length, 'bytes');
            this.ui.showNotification('ğŸ—‚ï¸ Imagen comprimida para Firebase', 'info');
          }
          
          // Obtener datos del perfil si estÃ¡ logueado
          let profilePicture = null;
          let profileAvatar = null;
          
          if (this.profiles && this.profiles.isLoggedIn()) {
            const profile = this.profiles.currentProfile;
            if (profile.avatarType === 'image' && profile.avatarImage) {
              profilePicture = profile.avatarImage;
            } else if (profile.avatarType === 'emoji' && profile.avatar) {
              profileAvatar = profile.avatar;
            }
          }
          
          const drawingData = {
            titulo: `Dibujo de ${author}`,
            imagenData: imageData,
            timestamp: Date.now(),
            autor: author,
            categoria: category,
            domain: 'thisisfenix.github.io',
            likes: 0,
            comments: [],
            layers: this.canvas.getLayers(),
            filters: this.canvas.getAppliedFilters(),
            isAnimated: frameCount > 1,
            strokes: this.canvas.getStrokeCount ? this.canvas.getStrokeCount() : 0,
            profilePicture: profilePicture,
            profileAvatar: profileAvatar,
            isLoggedUser: this.profiles ? this.profiles.isLoggedIn() : false,
            userProfile: this.profiles && this.profiles.isLoggedIn() ? {
              username: this.profiles.currentProfile.username,
              joinDate: this.profiles.currentProfile.joinDate,
              totalDrawings: this.profiles.currentProfile.totalDrawings
            } : null
          };
          
          // Si es GIF animado, guardar en backgroundGif
          if (frameCount > 1) {
            drawingData.backgroundGif = imageData;
          }
          
          // Guardar fondo GIF si existe
          if (this.isBackgroundGif && this.currentBackgroundImage) {
            const bgSize = this.currentBackgroundImage.src.length;
            if (bgSize > 800000) {
              console.warn('âš ï¸ Fondo GIF muy grande:', bgSize, 'bytes');
              this.ui.showNotification('âš ï¸ Fondo GIF muy grande, se comprimirÃ¡', 'warning');
              drawingData.backgroundGif = await this.compressGifForFirebase(this.currentBackgroundImage.src);
            } else {
              drawingData.backgroundGif = this.currentBackgroundImage.src;
            }
          }
          
          // Guardar stickers GIF animados (solo datos primitivos)
          if (this.gifStickers && this.gifStickers.length > 0) {
            drawingData.gifStickers = this.gifStickers.map(s => {
              // Verificar tamaÃ±o del src
              const srcSize = s.src ? s.src.length : 0;
              if (srcSize > 800000) { // ~800KB
                console.warn('âš ï¸ Sticker GIF muy grande, se omitirÃ¡:', srcSize, 'bytes');
                return null;
              }
              
              return {
                src: String(s.src || ''),
                x: Number(s.x) || 0,
                y: Number(s.y) || 0,
                width: Number(s.width) || 60,
                height: Number(s.height) || 60
              };
            }).filter(s => s !== null); // Filtrar stickers nulos
          }
          
          await this.firebase.saveDrawing(drawingData);
          
          this.canvas.clear();
          
          // Solo limpiar el nombre si no estÃ¡ logueado
          if (!this.profiles || !this.profiles.isLoggedIn()) {
            document.getElementById('authorName').value = '';
          }
          
          document.getElementById('categorySelect').value = 'Arte';
          
          // Actualizar estadÃ­sticas del perfil si estÃ¡ logueado
          if (this.profiles && this.profiles.isLoggedIn()) {
            this.profiles.currentProfile.totalDrawings = (this.profiles.currentProfile.totalDrawings || 0) + 1;
            this.profiles.saveProfile();
          }
          
          // ğŸ”— SINCRONIZACIÃ“N DE LOGROS - Marcar dibujo creado
          if (window.guestbookSync) {
            window.guestbookSync.incrementDrawingCount();
          }
          
          // Disparar evento personalizado para el sistema de logros
          document.dispatchEvent(new CustomEvent('drawing-saved', {
            detail: {
              author: author,
              category: category,
              timestamp: Date.now()
            }
          }));
          
          // Limpiar fondos y stickers GIF
          this.hideVisualGifBackground();
          document.getElementById('gifStickersContainer').innerHTML = '';
          this.gifStickers = [];
          this.currentBackgroundImage = null;
          this.isBackgroundGif = false;
          this.currentStickerImage = null;
          this.isStickerGif = false;
          
          // Resetear botones
          document.getElementById('setBgBtn').disabled = true;
          document.getElementById('setBgBtn').innerHTML = 'ğŸ–¼ï¸ Aplicar Fondo';
          document.getElementById('placeStickerBtn').disabled = true;
          document.getElementById('placeStickerBtn').innerHTML = 'ğŸ“Œ Sticker';
          document.getElementById('bgUpload').value = '';
          document.getElementById('stickerUpload').value = '';
          
          // Marcar como guardado
          window.hasUnsavedChanges = false;
          
          this.ui.showNotification('âœ… Â¡Dibujo guardado!', 'success');
          this.ui.createConfetti();
          
          // Actualizar galerÃ­a
          setTimeout(() => {
            this.gallery.loadGallery();
            document.getElementById('gallery').scrollIntoView({ behavior: 'smooth' });
          }, 1000);
          
        } catch (error) {
          console.error('Error:', error);
          
          // Mensajes de error mÃ¡s especÃ­ficos
          let errorMessage = 'âŒ Error al guardar';
          if (error.message && error.message.includes('invalid nested entity')) {
            errorMessage = 'âŒ Error: Datos demasiado complejos para Firebase';
          } else if (error.message && error.message.includes('too large')) {
            errorMessage = 'âŒ Error: Archivo muy grande (mÃ¡x 800KB)';
          } else if (error.code === 'permission-denied') {
            errorMessage = 'âŒ Error: Sin permisos para guardar';
          } else if (error.code === 'unavailable') {
            errorMessage = 'âŒ Error: Servicio no disponible';
          }
          
          this.ui.showNotification(errorMessage, 'error');
        } finally {
          saveBtn.disabled = false;
          saveText.style.display = 'inline';
          saveLoader.style.display = 'none';
        }
      }
      
      handleBackgroundUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Verificar tamaÃ±o de archivo (mÃ¡x 3MB para evitar problemas)
        if (file.size > 3 * 1024 * 1024) {
          this.ui.showNotification('ğŸš« Archivo muy grande. MÃ¡ximo 3MB permitido.', 'error');
          e.target.value = '';
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            this.currentBackgroundImage = img;
            this.isBackgroundGif = file.type === 'image/gif';
            
            const btn = document.getElementById('setBgBtn');
            btn.disabled = false;
            
            if (this.isBackgroundGif) {
              btn.innerHTML = 'ğŸ¬ GIF Listo';
              btn.style.background = '#28a745';
              btn.style.color = 'white';
            } else {
              btn.innerHTML = 'ğŸ–¼ï¸ Listo';
              btn.style.background = '';
              btn.style.color = '';
            }
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
      
      setBackground() {
        if (!this.currentBackgroundImage) return;
        
        // Si es GIF, usar fondo visual animado
        if (this.isBackgroundGif) {
          this.setVisualGifBackground(this.currentBackgroundImage.src);
        } else {
          // Para imÃ¡genes estÃ¡ticas, dibujar en canvas
          this.hideVisualGifBackground();
          
          // Guardar el dibujo actual
          const tempCanvas = document.createElement('canvas');
          tempCanvas.width = this.canvas.canvas.width;
          tempCanvas.height = this.canvas.canvas.height;
          const tempCtx = tempCanvas.getContext('2d');
          tempCtx.drawImage(this.canvas.canvas, 0, 0);
          
          // Limpiar canvas
          this.canvas.ctx.clearRect(0, 0, this.canvas.canvas.width, this.canvas.canvas.height);
          
          // Dibujar imagen de fondo adaptada al canvas
          this.canvas.ctx.drawImage(this.currentBackgroundImage, 0, 0, this.canvas.canvas.width, this.canvas.canvas.height);
          
          // Restaurar el dibujo encima del fondo
          this.canvas.ctx.drawImage(tempCanvas, 0, 0);
        }
        
        this.canvas.saveState();
        
        const btn = document.getElementById('setBgBtn');
        if (this.isBackgroundGif) {
          btn.innerHTML = 'ğŸ¬ GIF Aplicado';
          btn.style.background = '#28a745';
          btn.style.color = 'white';
        } else {
          btn.innerHTML = 'âœ… Aplicado';
        }
        
        setTimeout(() => {
          btn.innerHTML = 'ğŸ–¼ï¸ Aplicar Fondo';
          btn.style.background = '';
          btn.style.color = '';
        }, 3000);
      }
      
      setVisualGifBackground(gifSrc) {
        const gifBackground = document.getElementById('gifBackground');
        const gifImg = document.getElementById('gifBackgroundImg');
        
        gifImg.src = gifSrc;
        gifBackground.style.display = 'block';
        
        // Ajustar el contenedor GIF al tamaÃ±o actual del canvas
        gifBackground.style.width = this.canvas.canvas.width + 'px';
        gifBackground.style.height = this.canvas.canvas.height + 'px';
        
        // CRÃTICO: Hacer el canvas completamente transparente para que se vea el GIF
        this.canvas.canvas.style.background = 'transparent';
        
        this.ui.showNotification('ğŸ¬ GIF de fondo aplicado. Dibuja encima!', 'success');
      }
      
      hideVisualGifBackground() {
        const gifBackground = document.getElementById('gifBackground');
        gifBackground.style.display = 'none';
        // Restaurar fondo blanco del canvas
        this.canvas.canvas.style.background = 'white';
      }
      
      clearBackground() {
        if (!confirm('Â¿Quitar el fondo de imagen?')) return;
        
        // Guardar el dibujo actual
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = this.canvas.canvas.width;
        tempCanvas.height = this.canvas.canvas.height;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.drawImage(this.canvas.canvas, 0, 0);
        
        // Limpiar canvas completamente
        this.canvas.ctx.clearRect(0, 0, this.canvas.canvas.width, this.canvas.canvas.height);
        
        // Solo restaurar el dibujo (sin fondo)
        this.canvas.ctx.globalCompositeOperation = 'source-over';
        this.canvas.ctx.drawImage(tempCanvas, 0, 0);
        
        // Limpiar variables de fondo
        this.currentBackgroundImage = null;
        this.isBackgroundGif = false;
        this.hideVisualGifBackground();
        
        this.canvas.saveState();
        this.ui.showNotification('âœ… Fondo eliminado', 'success');
      }
      
      handleStickerUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Verificar tamaÃ±o de archivo (mÃ¡x 2MB para stickers)
        if (file.size > 2 * 1024 * 1024) {
          this.ui.showNotification('ğŸš« Sticker muy grande. MÃ¡ximo 2MB permitido.', 'error');
          e.target.value = '';
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            this.currentStickerImage = img;
            this.isStickerGif = file.type === 'image/gif';
            
            const btn = document.getElementById('placeStickerBtn');
            btn.disabled = false;
            
            // Mostrar preview si es GIF
            if (this.isStickerGif) {
              btn.innerHTML = 'ğŸ“Œ GIF Listo';
              btn.style.background = '#28a745';
              btn.style.color = 'white';
            } else {
              btn.innerHTML = 'ğŸ“Œ Listo';
              btn.style.background = '';
              btn.style.color = '';
            }
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
      
      placeSticker() {
        if (!this.currentStickerImage) return;
        
        this.canvas.canvas.style.cursor = 'copy';
        this.ui.showNotification('ğŸ“Œ Haz clic donde quieras colocar el sticker', 'info');
        
        const placeHandler = (e) => {
          const rect = this.canvas.canvas.getBoundingClientRect();
          const x = (e.clientX - rect.left) * (this.canvas.canvas.width / rect.width) - 30;
          const y = (e.clientY - rect.top) * (this.canvas.canvas.height / rect.height) - 30;
          
          if (this.isStickerGif) {
            // Para GIFs, crear elemento HTML animado
            this.createGifStickerElement({
              id: Date.now(),
              image: this.currentStickerImage,
              x: x,
              y: y,
              width: 60,
              height: 60,
              isGif: true
            });
          } else {
            // Para imÃ¡genes estÃ¡ticas, dibujar en canvas
            this.canvas.ctx.drawImage(this.currentStickerImage, x, y, 60, 60);
          }
          
          this.canvas.canvas.style.cursor = 'crosshair';
          this.canvas.canvas.removeEventListener('click', placeHandler);
          this.canvas.saveState();
        };
        
        this.canvas.canvas.addEventListener('click', placeHandler, { once: true });
      }
      
      createGifStickerElement(sticker) {
        const container = document.getElementById('gifStickersContainer');
        const gifElement = document.createElement('img');
        
        gifElement.src = sticker.image.src;
        gifElement.style.cssText = `
          position: absolute;
          left: ${sticker.x}px;
          top: ${sticker.y}px;
          width: ${sticker.width}px;
          height: ${sticker.height}px;
          pointer-events: auto;
          cursor: grab;
          z-index: 10;
          image-rendering: auto;
        `;
        
        gifElement.dataset.stickerId = sticker.id;
        
        container.appendChild(gifElement);
        
        // Agregar a la lista de stickers para guardar (sin elemento DOM)
        if (!this.gifStickers) this.gifStickers = [];
        const stickerData = {
          src: sticker.image.src,
          x: sticker.x,
          y: sticker.y,
          width: sticker.width,
          height: sticker.height
        };
        
        // Verificar tamaÃ±o antes de agregar
        const srcSize = stickerData.src ? stickerData.src.length : 0;
        if (srcSize > 800000) {
          this.ui.showNotification('âš ï¸ Sticker GIF muy grande (>800KB), se guardarÃ¡ localmente pero no en Firebase', 'warning');
        }
        
        // Agregar referencia al elemento para mover
        stickerData.element = gifElement;
        this.gifStickers.push(stickerData);
      }
      
      setStickerMoveTool() {
        this.currentTool = 'stickerMove';
        this.canvas.canvas.style.cursor = 'grab';
        this.updateToolButtons('stickerMoveBtn');
        this.ui.showNotification('âœ‹ Herramienta de mover stickers activada', 'info');
      }
      
      updateToolButtons(activeButtonId) {
        // Remover clase activa de todos los botones
        document.querySelectorAll('.btn-neon').forEach(btn => btn.classList.remove('btn-primary'));
        // Agregar clase activa al botÃ³n seleccionado
        const activeBtn = document.getElementById(activeButtonId);
        if (activeBtn) {
          activeBtn.classList.add('btn-primary');
        }
      }
      
      setupStickerMoveEvents() {
        const canvas = this.canvas.canvas;
        
        // FunciÃ³n para limpiar el estado de arrastre
        const cleanupDrag = () => {
          if (this.isDragging) {
            this.isDragging = false;
            this.selectedSticker = null;
            canvas.style.cursor = this.currentTool === 'stickerMove' ? 'grab' : 'crosshair';
            this.canvas.saveState();
          }
        };
        
        canvas.addEventListener('mousedown', (e) => {
          if (this.currentTool === 'stickerMove') {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            this.selectedSticker = this.findStickerAt(x, y);
            if (this.selectedSticker) {
              this.isDragging = true;
              canvas.style.cursor = 'grabbing';
              e.preventDefault();
              e.stopPropagation();
            }
          }
        });
        
        canvas.addEventListener('mousemove', (e) => {
          if (this.currentTool === 'stickerMove' && this.isDragging && this.selectedSticker) {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            // Centrar el sticker en el punto de toque
            const centerOffsetX = this.selectedSticker.width / 2;
            const centerOffsetY = this.selectedSticker.height / 2;
            this.selectedSticker.x = x - centerOffsetX;
            this.selectedSticker.y = y - centerOffsetY;
            
            // Mantener dentro del canvas
            this.selectedSticker.x = Math.max(0, Math.min(canvas.width - this.selectedSticker.width, this.selectedSticker.x));
            this.selectedSticker.y = Math.max(0, Math.min(canvas.height - this.selectedSticker.height, this.selectedSticker.y));
            
            // Actualizar posiciÃ³n del elemento
            if (this.selectedSticker.element) {
              this.selectedSticker.element.style.left = this.selectedSticker.x + 'px';
              this.selectedSticker.element.style.top = this.selectedSticker.y + 'px';
            }
            
            e.preventDefault();
            e.stopPropagation();
          }
        });
        
        // Eventos de mouseup en canvas y document para asegurar que se libere
        canvas.addEventListener('mouseup', cleanupDrag);
        document.addEventListener('mouseup', cleanupDrag);
        
        // Limpiar cuando el mouse sale del canvas
        canvas.addEventListener('mouseleave', cleanupDrag);
        
        // Limpiar cuando se cambia de herramienta
        const originalSetTool = this.canvas.setTool;
        this.canvas.setTool = (tool) => {
          cleanupDrag();
          originalSetTool.call(this.canvas, tool);
        };
        
        // Touch events para mÃ³vil con mejor manejo
        canvas.addEventListener('touchstart', (e) => {
          if (this.currentTool === 'stickerMove') {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = (touch.clientX - rect.left) * (canvas.width / rect.width);
            const y = (touch.clientY - rect.top) * (canvas.height / rect.height);
            
            this.selectedSticker = this.findStickerAt(x, y);
            if (this.selectedSticker) {
              this.isDragging = true;
              canvas.style.cursor = 'grabbing';
            }
          }
        }, { passive: false });
        
        canvas.addEventListener('touchmove', (e) => {
          if (this.currentTool === 'stickerMove' && this.isDragging && this.selectedSticker) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = (touch.clientX - rect.left) * (canvas.width / rect.width);
            const y = (touch.clientY - rect.top) * (canvas.height / rect.height);
            
            // Centrar el sticker en el punto de toque
            const centerOffsetX = this.selectedSticker.width / 2;
            const centerOffsetY = this.selectedSticker.height / 2;
            this.selectedSticker.x = x - centerOffsetX;
            this.selectedSticker.y = y - centerOffsetY;
            
            // Mantener dentro del canvas
            this.selectedSticker.x = Math.max(0, Math.min(canvas.width - this.selectedSticker.width, this.selectedSticker.x));
            this.selectedSticker.y = Math.max(0, Math.min(canvas.height - this.selectedSticker.height, this.selectedSticker.y));
            
            // Actualizar posiciÃ³n del elemento
            if (this.selectedSticker.element) {
              this.selectedSticker.element.style.left = this.selectedSticker.x + 'px';
              this.selectedSticker.element.style.top = this.selectedSticker.y + 'px';
            }
          }
        }, { passive: false });
        
        canvas.addEventListener('touchend', cleanupDrag, { passive: false });
        canvas.addEventListener('touchcancel', cleanupDrag, { passive: false });
        
        // Limpiar cuando se pierde el foco de la ventana
        window.addEventListener('blur', cleanupDrag);
        
        // Limpiar cuando se presiona Escape
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.isDragging) {
            cleanupDrag();
            this.ui.showNotification('âŒ Movimiento de sticker cancelado', 'info');
          }
        });
      }
      
      findStickerAt(x, y) {
        if (!this.gifStickers) return null;
        
        // Buscar desde el Ãºltimo (mÃ¡s arriba) hacia el primero
        for (let i = this.gifStickers.length - 1; i >= 0; i--) {
          const sticker = this.gifStickers[i];
          if (!sticker) continue;
          
          const margin = 10; // Margen para facilitar la selecciÃ³n
          
          if (x >= sticker.x - margin && x <= sticker.x + sticker.width + margin &&
              y >= sticker.y - margin && y <= sticker.y + sticker.height + margin) {
            return sticker;
          }
        }
        return null;
      }
      
      async submitSuggestion() {
        const text = document.getElementById('suggestionText').value.trim();
        const type = document.getElementById('suggestionType').value;
        const imageFile = document.getElementById('suggestionImage').files[0];
        
        if (!text) {
          this.ui.showNotification('âœï¸ Escribe tu sugerencia primero', 'error');
          return;
        }
        
        try {
          let imageData = null;
          
          if (imageFile) {
            if (imageFile.size > 2 * 1024 * 1024) {
              this.ui.showNotification('ğŸš« Imagen muy grande. MÃ¡ximo 2MB.', 'error');
              return;
            }
            
            imageData = await this.processImageForSuggestion(imageFile);
          }
          
          const suggestionData = {
            texto: text,
            tipo: type,
            timestamp: Date.now(),
            autor: document.getElementById('authorName').value.trim() || 'AnÃ³nimo',
            domain: 'thisisfenix.github.io',
            status: 'pendiente'
          };
          
          if (imageData) {
            suggestionData.imagen = imageData;
          }
          
          await this.firebase.saveSuggestion(suggestionData);
          
          document.getElementById('suggestionText').value = '';
          document.getElementById('suggestionImage').value = '';
          this.ui.showNotification('âœ… Sugerencia enviada', 'success');
          this.loadRecentSuggestions();
          
        } catch (error) {
          console.error('Error:', error);
          this.ui.showNotification('âŒ Error al enviar sugerencia', 'error');
        }
      }
      
      // ğŸ”— Funciones para sincronizar logros con el laboratory
      setupGuestbookAchievementSync() {
        // Interceptar clicks en botones de like
        document.addEventListener('click', (event) => {
          if (event.target.matches('.like-btn, .btn-like, [data-action="like"]')) {
            this.handleLikeAction();
          }
        });
        
        // Interceptar envÃ­o de comentarios
        document.addEventListener('submit', (event) => {
          if (event.target.matches('.comment-form, [data-form="comment"]')) {
            this.handleCommentAction();
          }
        });
        
        // Interceptar cuando se abre un modal de comentarios
        document.addEventListener('click', (event) => {
          if (event.target.matches('.comment-btn, .btn-comment, [data-action="comment"]')) {
            // Esperar un poco para que se abra el modal
            setTimeout(() => {
              this.setupCommentFormListeners();
            }, 500);
          }
        });
      }
      
      handleLikeAction() {
        if (window.guestbookSync) {
          window.guestbookSync.incrementLikeCount();
        }
        
        // Disparar evento personalizado
        document.dispatchEvent(new CustomEvent('like-given', {
          detail: {
            timestamp: Date.now()
          }
        }));
      }
      
      handleCommentAction() {
        if (window.guestbookSync) {
          window.guestbookSync.incrementCommentCount();
        }
        
        // Disparar evento personalizado
        document.dispatchEvent(new CustomEvent('comment-posted', {
          detail: {
            timestamp: Date.now()
          }
        }));
      }
      
      setupCommentFormListeners() {
        // Buscar formularios de comentarios en modales
        const commentForms = document.querySelectorAll('.modal textarea, .comment-textarea');
        commentForms.forEach(textarea => {
          if (!textarea.dataset.listenerAdded) {
            textarea.dataset.listenerAdded = 'true';
            
            // Buscar el botÃ³n de enviar asociado
            const submitBtn = textarea.closest('.modal-body, .comment-section')
              ?.querySelector('button[onclick*="comment"], .comment-submit, .btn-primary');
            
            if (submitBtn) {
              submitBtn.addEventListener('click', () => {
                if (textarea.value.trim()) {
                  this.handleCommentAction();
                }
              });
            }
          }
        });
      }
      
      processImageForSuggestion(file) {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              
              // Redimensionar si es muy grande
              const maxSize = 300;
              let { width, height } = img;
              
              if (width > maxSize || height > maxSize) {
                if (width > height) {
                  height = (height * maxSize) / width;
                  width = maxSize;
                } else {
                  width = (width * maxSize) / height;
                  height = maxSize;
                }
              }
              
              canvas.width = width;
              canvas.height = height;
              ctx.drawImage(img, 0, 0, width, height);
              
              resolve(canvas.toDataURL('image/jpeg', 0.8));
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      }
      
      async loadRecentSuggestions() {
        try {
          const suggestions = await this.firebase.getRecentSuggestions();
          const container = document.getElementById('recentSuggestions');
          
          if (!container) return;
          
          if (!suggestions || suggestions.length === 0) {
            container.innerHTML = '<div class="text-muted">No hay sugerencias aÃºn</div>';
            return;
          }
          
          container.innerHTML = suggestions.map(s => `
            <div class="mb-2 p-2" style="background: rgba(255,255,255,0.1); border-radius: 6px; border-left: 3px solid var(--primary);">
              <div class="d-flex justify-content-between mb-1">
                <span class="text-warning small">${this.getSuggestionIcon(s.tipo)} <strong>${s.autor || 'AnÃ³nimo'}</strong></span>
                <small class="text-muted">${this.formatDate(s.timestamp)}</small>
              </div>
              <div class="text-light small">${s.texto || 'Sin texto'}</div>
              ${s.imagen ? `<div class="mt-2"><img src="${s.imagen}" style="max-width: 100%; max-height: 100px; border-radius: 4px; cursor: pointer;" onclick="this.style.maxHeight=this.style.maxHeight=='100px'?'300px':'100px'"></div>` : ''}
              <div class="mt-1">
                <span class="badge bg-secondary" style="font-size: 0.6em;">${this.getSuggestionTypeText(s.tipo)}</span>
                ${this.getSuggestionStatusBadge(s.status)}
              </div>
            </div>
          `).join('');
          
        } catch (error) {
          console.error('Error loading suggestions:', error);
          const container = document.getElementById('recentSuggestions');
          if (container) {
            container.innerHTML = '<div class="text-danger small">Error cargando sugerencias</div>';
          }
        }
      }
      
      getSuggestionStatusBadge(status) {
        const badges = {
          'pendiente': '<span class="badge bg-warning text-dark ms-1" style="font-size: 0.6em;">â³ Pendiente</span>',
          'proceso': '<span class="badge bg-info ms-1" style="font-size: 0.6em;">ğŸ”„ En Proceso</span>',
          'aprobado': '<span class="badge bg-success ms-1" style="font-size: 0.6em;">âœ… Aprobado</span>',
          'rechazado': '<span class="badge bg-danger ms-1" style="font-size: 0.6em;">âŒ Rechazado</span>'
        };
        return badges[status] || badges['pendiente'];
      }
      
      async loadAdminSuggestions() {
        // Funcionalidad removida - sin panel admin
      }
      
      async loadAdminDrawings() {
        // Funcionalidad removida - sin panel admin
      }
      
      async loadAdminReports() {
        // Funcionalidad removida - sin panel admin
      }
      
      updateReportCounters(pendingCount) {
        // Funcionalidad removida - sin paneles admin/mod
      }
      
      startReportCounterUpdates() {
        // Funcionalidad removida - sin paneles admin/mod
      }
      
      getSuggestionIcon(type) {
        const icons = {
          'feature': 'âœ¨',
          'bug': 'ğŸ›',
          'improvement': 'ğŸ”§',
          'other': 'ğŸ’­'
        };
        return icons[type] || 'ğŸ’­';
      }
      
      getSuggestionTypeText(type) {
        const types = {
          'feature': 'Nueva FunciÃ³n',
          'bug': 'Bug Report',
          'improvement': 'Mejora',
          'other': 'Otro'
        };
        return types[type] || 'Otro';
      }
      
      formatDate(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        
        if (diff < 60000) return 'hace un momento';
        if (diff < 3600000) return `hace ${Math.floor(diff/60000)}m`;
        if (diff < 86400000) return `hace ${Math.floor(diff/3600000)}h`;
        return `hace ${Math.floor(diff/86400000)}d`;
      }
      
      saveUserColor(color) {
        localStorage.setItem('guestbook-user-color', color);
      }
      
      loadUserColor() {
        const savedColor = localStorage.getItem('guestbook-user-color');
        if (savedColor) {
          // Buscar si el color estÃ¡ en los botones predefinidos
          const colorBtn = document.querySelector(`[data-color="${savedColor}"]`);
          if (colorBtn) {
            document.querySelector('.color-btn.active')?.classList.remove('active');
            colorBtn.classList.add('active');
          } else {
            // Si es un color personalizado, establecerlo en el input
            const customColorInput = document.getElementById('customColor');
            if (customColorInput) {
              customColorInput.value = savedColor;
            }
          }
          this.canvas.setColor(savedColor);
        }
        
        // El sistema de perfiles ahora se maneja en ProfileManager
      }
      
      loadUserProfile() {
        // Configurar botÃ³n "Usar perfil" para el nuevo sistema
        const useProfileBtn = document.getElementById('useProfileName');
        if (useProfileBtn) {
          useProfileBtn.addEventListener('click', () => {
            if (this.profiles && this.profiles.isLoggedIn()) {
              document.getElementById('authorName').value = this.profiles.currentProfile.username;
              this.ui.showNotification('âœ… Nombre de perfil aplicado', 'success');
            } else {
              this.ui.showNotification('âš ï¸ Inicia sesiÃ³n primero', 'warning');
              if (this.profiles) {
                this.profiles.showProfileModal();
              }
            }
          });
        }
      }
      
      // La funciÃ³n processProfilePicture ya no es necesaria - se maneja en ProfileManager
      
      // FunciÃ³n para comprimir GIFs manteniendo animaciÃ³n
      async compressGifForFirebase(gifDataUrl) {
        if (!gifDataUrl) return null;
        
        try {
          // Convertir dataURL a blob
          const response = await fetch(gifDataUrl);
          const blob = await response.blob();
          
          // Si el GIF es pequeÃ±o, devolverlo sin comprimir
          if (blob.size < 800000) {
            return gifDataUrl;
          }
          
          // Para GIFs grandes, crear una versiÃ³n comprimida simple
          return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              
              // Reducir tamaÃ±o manteniendo proporciÃ³n
              const maxSize = 400;
              let { width, height } = img;
              
              if (width > maxSize || height > maxSize) {
                if (width > height) {
                  height = (height * maxSize) / width;
                  width = maxSize;
                } else {
                  width = (width * maxSize) / height;
                  height = maxSize;
                }
              }
              
              canvas.width = width;
              canvas.height = height;
              ctx.drawImage(img, 0, 0, width, height);
              
              // Comprimir como JPEG para reducir tamaÃ±o
              const compressed = canvas.toDataURL('image/jpeg', 0.6);
              console.log(`GIF comprimido: ${gifDataUrl.length} â†’ ${compressed.length} bytes`);
              resolve(compressed);
            };
            
            img.onerror = () => {
              console.log('Error comprimiendo GIF, usando original');
              resolve(gifDataUrl);
            };
            
            img.src = gifDataUrl;
          });
        } catch (error) {
          console.error('Error comprimiendo GIF:', error);
          return gifDataUrl;
        }
      }
      
      // FunciÃ³n para comprimir imÃ¡genes
      async compressImage(dataUrl, maxSizeKB = 600) {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Calcular nuevo tamaÃ±o manteniendo proporciÃ³n
            let { width, height } = img;
            const maxDimension = 800;
            
            if (width > maxDimension || height > maxDimension) {
              if (width > height) {
                height = (height * maxDimension) / width;
                width = maxDimension;
              } else {
                width = (width * maxDimension) / height;
                height = maxDimension;
              }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // Dibujar imagen redimensionada
            ctx.drawImage(img, 0, 0, width, height);
            
            // Comprimir con calidad variable
            let quality = 0.8;
            let compressed = canvas.toDataURL('image/jpeg', quality);
            
            // Reducir calidad hasta alcanzar el tamaÃ±o objetivo
            while (compressed.length > maxSizeKB * 1024 * 1.37 && quality > 0.3) {
              quality -= 0.1;
              compressed = canvas.toDataURL('image/jpeg', quality);
            }
            
            resolve(compressed);
          };
          img.src = dataUrl;
        });
      }
      
      setupMobileEnhancements() {
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile) {
          // Mejorar touch events para canvas
          const canvas = this.canvas.canvas;
          if (canvas) {
            // Prevenir scroll cuando se dibuja
            canvas.addEventListener('touchstart', (e) => {
              if (this.currentTool !== 'stickerMove') {
                e.preventDefault();
              }
            }, { passive: false });
            
            canvas.addEventListener('touchmove', (e) => {
              if (this.currentTool !== 'stickerMove') {
                e.preventDefault();
              }
            }, { passive: false });
          }
          
          // Ajustar tamaÃ±o de canvas para mÃ³viles pequeÃ±os
          if (window.innerWidth < 480) {
            this.resizeCanvas(400, 300);
          }
          
          // Configurar gestos de pellizco para zoom (futuro)
          this.setupPinchZoom();
        }
      }
      
      setupPinchZoom() {
        const canvas = this.canvas.canvas;
        if (!canvas) return;
        
        let initialDistance = 0;
        let initialScale = 1;
        
        canvas.addEventListener('touchstart', (e) => {
          if (e.touches.length === 2) {
            initialDistance = this.getDistance(e.touches[0], e.touches[1]);
            initialScale = this.canvas.zoomLevel || 1;
          }
        });
        
        canvas.addEventListener('touchmove', (e) => {
          if (e.touches.length === 2) {
            e.preventDefault();
            const currentDistance = this.getDistance(e.touches[0], e.touches[1]);
            const scale = (currentDistance / initialDistance) * initialScale;
            
            // Limitar zoom entre 0.5x y 3x
            const clampedScale = Math.max(0.5, Math.min(3, scale));
            
            if (this.canvas.setZoom) {
              this.canvas.setZoom(clampedScale);
              this.updateZoomInfo();
            }
          }
        }, { passive: false });
      }
      
      getDistance(touch1, touch2) {
        const dx = touch1.clientX - touch2.clientX;
        const dy = touch1.clientY - touch2.clientY;
        return Math.sqrt(dx * dx + dy * dy);
      }
      
      setupUnsavedChangesDetection() {
        const canvas = this.canvas.canvas;
        if (!canvas) return;
        
        // Detectar cambios en el canvas
        const detectChange = () => {
          window.hasUnsavedChanges = true;
        };
        
        // Eventos de dibujo
        canvas.addEventListener('mousedown', detectChange);
        canvas.addEventListener('touchstart', detectChange);
        
        // Detectar cambios en herramientas que modifican el canvas
        const toolButtons = [
          'brushBtn', 'eraserBtn', 'bucketBtn', 'textBtn',
          'sprayBtn', 'lineBtn', 'clearBtn', 'undoBtn', 'redoBtn'
        ];
        
        toolButtons.forEach(btnId => {
          const btn = document.getElementById(btnId);
          if (btn) {
            btn.addEventListener('click', detectChange);
          }
        });
        
        // Detectar importaciÃ³n de imÃ¡genes
        document.getElementById('importBtn')?.addEventListener('change', detectChange);
        document.getElementById('setBgBtn')?.addEventListener('click', detectChange);
        document.getElementById('placeStickerBtn')?.addEventListener('click', detectChange);
      }
    }
    
    // Inicializar aplicaciÃ³n con detecciÃ³n de OperaGX
    const app = new GuestbookApp();
    
    // InicializaciÃ³n especial para OperaGX
    if (navigator.userAgent.includes('OPR') && navigator.userAgent.includes('GX')) {
      console.log('ğŸ® Inicializando para OperaGX con configuraciÃ³n especial...');
      
      // Delay adicional para OperaGX
      setTimeout(() => {
        app.init();
      }, 1000);
      
      // Verificar conectividad despuÃ©s de 5 segundos
      setTimeout(() => {
        if (!window.guestbookApp || !window.guestbookApp.firebase) {
          console.warn('âš ï¸ Firebase no se inicializÃ³ correctamente en OperaGX');
          if (window.guestbookApp && window.guestbookApp.ui) {
            window.guestbookApp.ui.showNotification(
              'âš ï¸ Problemas de conectividad detectados. Recarga la pÃ¡gina o desactiva el bloqueador de anuncios.',
              'warning'
            );
          }
        }
      }, 5000);
    } else {
      app.init();
    }
    
    // Hacer disponible globalmente
    window.guestbookApp = app;
    
    // Prevenir errores de extensiones del navegador
    window.addEventListener('error', function(e) {
      const errorMessages = [
        'message channel closed',
        'Extension context invalidated',
        'The message port closed before a response was received',
        'A listener indicated an asynchronous response by returning true'
      ];
      
      if (e.message && errorMessages.some(msg => e.message.toLowerCase().includes(msg.toLowerCase()))) {
        e.preventDefault();
        e.stopPropagation();
        return true;
      }
    });
    
    window.addEventListener('unhandledrejection', function(e) {
      const errorMessages = [
        'message channel closed',
        'Extension context invalidated',
        'The message port closed before a response was received',
        'A listener indicated an asynchronous response by returning true'
      ];
      
      const errorText = e.reason?.message || e.reason?.toString() || '';
      if (errorText && errorMessages.some(msg => errorText.toLowerCase().includes(msg.toLowerCase()))) {
        e.preventDefault();
        e.stopPropagation();
        return true;
      }
    });
    // Variable global para cambios sin guardar
    window.hasUnsavedChanges = false;
    
    // FunciÃ³n para mostrar panel de updates
    window.toggleUpdatesPanel = function() {
      // Usar nuestro sistema de updates dinÃ¡mico en lugar del hardcodeado
      if (window.guestbookUpdates) {
        window.guestbookUpdates.showUpdatesModal();
      } else {
        // Fallback al modal hardcodeado si no estÃ¡ disponible
        const modal = new bootstrap.Modal(document.getElementById('updatesPanel'));
        modal.show();
      }
    };
    
    // Funciones de navegaciÃ³n mÃ³vil
    window.scrollToTop = function() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    
    window.scrollToCanvas = function() {
      const canvas = document.querySelector('.canvas-container');
      if (canvas) {
        canvas.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    };
    
    window.scrollToGallery = function() {
      const gallery = document.getElementById('gallery');
      if (gallery) {
        gallery.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    };
    
    window.toggleMobileMenu = function() {
      const menu = document.querySelector('.version-toggle');
      if (menu) {
        menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        setTimeout(() => {
          if (menu.style.display !== 'none') {
            menu.style.display = 'none';
          }
        }, 3000);
      }
    };
    
    // Mostrar/ocultar botÃ³n de scroll segÃºn posiciÃ³n
    window.addEventListener('scroll', function() {
      const scrollTopBtn = document.querySelector('.mobile-scroll-top');
      if (scrollTopBtn) {
        if (window.scrollY > 300) {
          scrollTopBtn.style.opacity = '1';
          scrollTopBtn.style.pointerEvents = 'auto';
        } else {
          scrollTopBtn.style.opacity = '0';
          scrollTopBtn.style.pointerEvents = 'none';
        }
      }
    });
    
    // FunciÃ³n global para refrescar pÃ¡gina
    window.refreshPage = function() {
      // Verificar cambios sin guardar
      if (window.hasUnsavedChanges) {
        const confirmRefresh = confirm(
          'âš ï¸ Â¿EstÃ¡s seguro de actualizar la pÃ¡gina?\n\n' +
          'ğŸ¨ Tienes cambios sin guardar en tu dibujo\n' +
          'ğŸ”„ Esta acciÃ³n limpiarÃ¡ el cache y recargarÃ¡ completamente la pÃ¡gina\n' +
          'ğŸ’¾ Se perderÃ¡n todos los cambios no guardados\n\n' +
          'âœ… Presiona OK para continuar\n' +
          'âŒ Presiona Cancelar para seguir dibujando'
        );
        
        if (!confirmRefresh) {
          return;
        }
      }
      
      // Mostrar animaciÃ³n de carga
      const btn = document.querySelector('.mobile-refresh');
      if (btn) {
        btn.innerHTML = 'â³';
        btn.style.animation = 'spin 1s linear infinite';
      }
      
      // Limpiar cache del service worker si existe
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
          for(let registration of registrations) {
            registration.unregister();
          }
        });
      }
      
      // Limpiar cache del navegador
      if ('caches' in window) {
        caches.keys().then(function(names) {
          for (let name of names) {
            caches.delete(name);
          }
        });
      }
      
      // Refrescar con cache bypass
      setTimeout(() => {
        window.location.reload(true);
      }, 500);
    };
    

    // Funciones para gestiÃ³n de usuarios
    window.loadUsersList = function() { /* Removido - usar admin-panel.js */ };
    window.selectUser = function() { /* Removido - usar admin-panel.js */ };
    window.warnUser = function() { /* Removido - usar admin-panel.js */ };
    window.blockUser = function() { /* Removido - usar admin-panel.js */ };
    window.unblockUser = function() { /* Removido - usar admin-panel.js */ };
    window.viewUserHistory = function() { /* Removido - usar admin-panel.js */ };
    // Funciones para logs de actividad
    window.loadActivityLogs = function() { /* Removido - usar admin-panel.js */ };
    // Funciones de configuraciÃ³n
    window.loadConfig = function() { /* Removido - usar admin-panel.js */ };
    window.saveConfig = function() { /* Removido - usar admin-panel.js */ };
    window.saveFilters = function() { /* Removido - usar admin-panel.js */ };
    // Funciones de exportaciÃ³n
    window.exportDrawings = function() { /* Removido - usar admin-panel.js */ };
    window.exportReports = function() { /* Removido - usar admin-panel.js */ };
    window.exportLogs = function() { /* Removido - usar admin-panel.js */ };
    // Funciones para moderadores
    window.loadModStats = function() { /* Removido - usar mod-panel.js */ };
    window.loadModReportedUsers = function() { /* Removido - usar mod-panel.js */ };
    window.loadModConfig = function() { /* Removido - usar mod-panel.js */ };
    window.changeModPassword = function() { /* Removido - usar mod-panel.js */ };
    window.saveModNotifications = function() { /* Removido - usar mod-panel.js */ };
    // Funciones para gestiÃ³n de comentarios
    window.loadAdminComments = function() { /* Removido - usar admin-panel.js */ };
    window.loadModComments = function() { /* Removido - usar mod-panel.js */ };
    window.deleteComment = function() { /* Removido - usar admin/mod-panel.js */ };
    window.viewDrawingFromComment = function() { /* Removido - usar admin/mod-panel.js */ };
  </script>
  
  <!-- Suprimir errores de extensiones -->
  <script>
    // Prevenir errores de extensiones del navegador y OperaGX
    const originalConsoleError = console.error;
    console.error = function(...args) {
      const message = args.join(' ');
      if (message.includes('message channel closed') || 
          message.includes('listener indicated an asynchronous response') ||
          message.includes('Failed to fetch') ||
          message.includes('NetworkError') ||
          message.includes('ERR_BLOCKED_BY_CLIENT')) {
        return; // Suprimir errores de conectividad y extensiones
      }
      originalConsoleError.apply(console, args);
    };
    
    // Detectar bloqueos de OperaGX y mostrar ayuda
    window.addEventListener('error', function(e) {
      if (e.message && (e.message.includes('Failed to fetch') || e.message.includes('NetworkError'))) {
        if (navigator.userAgent.includes('OPR') && navigator.userAgent.includes('GX')) {
          setTimeout(() => {
            if (window.guestbookApp && window.guestbookApp.ui) {
              window.guestbookApp.ui.showNotification(
                'ğŸš« OperaGX estÃ¡ bloqueando Firebase. Ve a ConfiguraciÃ³n > Bloqueador de anuncios > Excluir thisisfenix.github.io',
                'error'
              );
            }
          }, 1000);
        }
      }
    });
    
    // Agregar animaciones y estilos adicionales
    const style = document.createElement('style');
    style.textContent = `
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Transiciones suaves para botones flotantes */
      .mobile-scroll-top {
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }
      
      /* Mejoras para touch en iOS */
      .btn, .color-btn, .form-control, .form-select {
        -webkit-tap-highlight-color: rgba(0,0,0,0);
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
      }
      
      /* Prevenir zoom en inputs en iOS */
      @media screen and (max-width: 768px) {
        input[type="text"],
        input[type="password"],
        input[type="email"],
        input[type="number"],
        textarea,
        select {
          font-size: 16px !important;
        }
      }
      /* Mejorar visibilidad de elementos activos */
      .btn:active,
      .color-btn:active {
        transform: scale(0.95);
        transition: transform 0.1s ease;
      }
      
      /* Canvas mÃ¡s responsive */
      @media (max-width: 480px) {
        .canvas-container {
          max-width: 98vw;
          padding: 5px;
        }
        
        #drawCanvas {
          max-width: 100%;
          height: auto;
        }
        
        /* Comentarios ultra compactos */
        .image-modal .comments-container {
          max-height: 35vh !important;
        }
        
        .image-modal .comment-item {
          padding: 0.4rem !important;
          font-size: 12px !important;
        }
        
        .image-modal img {
          max-height: 20vh !important;
        }
      }
    `;
    document.head.appendChild(style);
    
    // Detectar dispositivo mÃ³vil y ajustar comportamiento
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const isOperaGX = navigator.userAgent.includes('OPR') && navigator.userAgent.includes('GX');
    
    // Detectar problemas de conectividad con Firebase en OperaGX
    if (isOperaGX) {
      console.warn('âš ï¸ OperaGX detectado - Aplicando workarounds para Firebase');
      
      // Timeout mÃ¡s largo para OperaGX
      if (window.guestbookApp && window.guestbookApp.firebase) {
        window.guestbookApp.firebase.timeout = 15000;
      }
      
      // Mostrar aviso especÃ­fico para OperaGX
      setTimeout(() => {
        if (window.guestbookApp && window.guestbookApp.ui) {
          window.guestbookApp.ui.showNotification(
            'ğŸ® OperaGX detectado: Si tienes problemas de conexiÃ³n, desactiva el bloqueador de anuncios para thisisfenix.github.io',
            'warning'
          );
        }
      }, 3000);
      
      // Reintentos automÃ¡ticos para OperaGX
      const originalFetch = window.fetch;
      window.fetch = function(...args) {
        return originalFetch.apply(this, args).catch(error => {
          console.warn('ğŸ”„ Reintentando conexiÃ³n Firebase para OperaGX...');
          return new Promise(resolve => {
            setTimeout(() => {
              resolve(originalFetch.apply(this, args));
            }, 2000);
          });
        });
      };
    }
    
    if (isMobile) {
      // Prevenir zoom en double tap
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function (event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
          event.preventDefault();
        }
        lastTouchEnd = now;
      }, false);
      
      // Mejorar scroll en modales
      document.addEventListener('touchmove', function(e) {
        if (e.target.closest('.image-modal')) {
          // Permitir scroll en modales
          return;
        }
      }, { passive: true });
    }
  </script>
</body>
</html>